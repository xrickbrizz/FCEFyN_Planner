<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FCEFyN Planner — Acceso</title>
  <link rel="stylesheet" href="styles/global.css">
  <link rel="stylesheet" href="styles/app.css">
  <script src="scripts/theme-toggle.js" defer></script>
</head>
<body>
  <header>
      <div class="brand">
      <img class="logo" src="assets/fcefyn-logo.svg" alt="Logo FCEFyN" id="logoFcefyn" style="cursor: pointer"/>
      <div class="brand-txt">
        <div class="brand-title">FCEFyN Planner</div>
        <div class="brand-sub">Organizá tu cursado, horarios y estudio en un solo lugar</div>
      </div>
    </div>

    <div class="hdr-right">
      <a class="btn btn-outline" href="plans_index.html" title="Abrir Plan de Estudios">
        Plan de estudios
      </a>
      <div class="pill" id="pillFirebase"><span class="dot warn" id="dotFirebase"></span><span id="firebaseLabel">Estado del servicio</span></div>
      <div class="pill" id="pillClock">—</div>
    </div>
  </header>

  <div class="shell">
    <div class="hero-grid">
      <section class="card card-hero">
        <div class="eyebrow">Planner académico — FCEFyN</div>
        <h1 class="hero-title">Tu espacio para planificar el cuatrimestre.</h1>
        <p class="hero-sub">
          Armá horarios por comisión, registrá tu estudio y llevá el seguimiento de parciales, TPs y tareas
          con una vista clara de todo lo que necesitas para tus materias.
        </p>

        <div class="highlight-row">
          <div>
            <div class="highlight-title">Tu próximo ingreso</div>
            <div class="highlight-big">Panel Estudiante</div>
            <div class="highlight-sub">Agenda semanal · Académico · Estudio · Planificador de comisiones</div>
          </div>
          <div class="chips-row">
            <span class="chip">Modo oscuro</span>
            <span class="chip">Tus materias al día</span>
            <span class="chip">Planificación simple</span>
          </div>
        </div>

        <div class="feature-grid">
          <div class="feat">
            <div class="feat-ico">A</div>
            <div>
              <b>Académico</b>
              <span>Parciales, TPs, tareas, informes y recordatorios.</span>
            </div>
          </div>
          <div class="feat">
            <div class="feat-ico">E</div>
            <div>
              <b>Estudio</b>
              <span>Registrá horas, tema y materia por día.</span>
            </div>
          </div>
          <div class="feat">
            <div class="feat-ico">H</div>
            <div>
              <b>Horario</b>
              <span>Agenda semanal 08:00–23:00 con bloques.</span>
            </div>
          </div>
          <div class="feat">
            <div class="feat-ico">P</div>
            <div>
              <b>Presets</b>
              <span>Simulá comisiones y pasalas a tu agenda.</span>
            </div>
          </div>
        </div>

        <div class="metric-row">
          <div class="metric-card">
            <div class="metric-label">Acceso directo</div>
            <div class="metric-value">Tu semana en orden</div>
            <div class="metric-sub">Entrá y empezá a organizar tu cursado.</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Carreras</div>
            <div class="metric-value">Civil · Industrial · Sistemas</div>
            <div class="metric-sub">Y cualquier otra de la FCEFyN.</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Experiencia</div>
            <div class="metric-value">Diseño claro</div>
            <div class="metric-sub">Información simple para enfocarte en estudiar.</div>
          </div>
        </div>

        <div class="footer-note">
          <div><strong>Registro</strong>: usá tu correo <strong>@mi.unc.edu.ar</strong> para crear tu cuenta.</div>
        </div>
      </section>

      <section class="card card-auth">
        <div class="auth-top">
          <div>
            <div class="eyebrow">Bienvenido/a</div>
            <h2 class="auth-title">Ingresá o creá tu cuenta</h2>
            <p class="auth-sub">Accedé para planificar tu cursado en segundos.</p>
          </div>

          <div class="segmented">
            <button id="btnModeLogin" class="active" type="button">Iniciar sesión</button>
            <button id="btnModeSignup" type="button">Crear cuenta</button>
          </div>
        </div>

        <div class="auth-hint-row">
          <div class="auth-pill">Todo listo para empezar</div>
          <div class="auth-pill ghost" id="authHint">Organizá horarios, estudio y parciales desde el inicio</div>
        </div>

        <div id="authForm" class="auth-form">
          <div class="form-grid">
            <div class="form-group">
              <label>Correo o Documento</label>
              <input id="inpEmail" type="text" placeholder="tuusuario@mi.unc.edu.ar o DNI" autocomplete="username" />
            </div>
            <div class="form-group">
              <label>Contraseña</label>
              <div class="pwd-wrap">
                <input id="inpPass" type="password" placeholder="••••••••" autocomplete="current-password" />
                <button id="btnTogglePass" class="pwd-toggle" type="button">ver</button>
              </div>
            </div>
          </div>

          <div id="signupExtra" class="form-grid signup-extra" style="display:none;">
            <div class="form-group">
              <label>Nombre</label>
              <input id="inpName" type="text" placeholder="Ej: Sofía" autocomplete="given-name" />
            </div>
            <div class="form-group">
              <label>Apellido</label>
              <input id="inpLast" type="text" placeholder="Ej: Domínguez" autocomplete="family-name" />
            </div>
            <div class="form-group">
              <label>Carrera</label>
              <select id="inpCareer">
                <option value="">Elegí tu carrera</option>
                <option>Ing. Civil</option>
                <option>Ing. Industrial</option>
                <option>Ing. en Sistemas</option>
                <option>Ing. Mecánica</option>
                <option>Ing. Eléctrica</option>
                <option>Otra</option>
              </select>
            </div>
            <div class="form-group">
              <label>Año de ingreso (opcional)</label>
              <input id="inpYear" type="number" placeholder="2024" inputmode="numeric" />
            </div>
            <div class="form-group">
              <label>Documento (opcional)</label>
              <input id="inpDocumento" type="text" placeholder="Documento (DNI)" />
            </div>
            <div class="form-group">
              <label>Confirmar contraseña</label>
              <div class="pwd-wrap">
                <input id="inpPass2" type="password" placeholder="••••••••" autocomplete="new-password" />
                <button id="btnTogglePass2" class="pwd-toggle" type="button">ver</button>
              </div>
            </div>
          </div>

          <div class="row actions-row">
            <div class="left">
              <button id="btnSubmit" class="btn btn-primary" type="button">Entrar</button>
              <button id="btnForgot" class="btn btn-ghost" type="button">Olvidé mi contraseña</button>
            </div>
          </div>

          <div class="notice" id="msgBox" style="display:none;"></div>
        </div>
      </section>
    </div>
  </div>
    <footer>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      serverTimestamp,
      collection,
      getDocs,
      query,
      where,
      limit
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import { getPlansIndex, normalizeStr } from "./scripts/plans-data.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA0i7hkXi5C-x3UwAEsh6FzRFqrFE5jpd8",
      authDomain: "fcefyn-planner.firebaseapp.com",
      projectId: "fcefyn-planner",
      storageBucket: "fcefyn-planner.firebasestorage.app",
      messagingSenderId: "713668406730",
      appId: "1:713668406730:web:f41c459641bfdce0cd7333"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const pillClock = document.getElementById("pillClock");
    const dotFirebase = document.getElementById("dotFirebase");
    const msgBox = document.getElementById("msgBox");
    const selCareer = document.getElementById("inpCareer");

    async function loadCareerOptions(){
      if (!selCareer) return;
      selCareer.innerHTML = `<option value="">Elegí tu carrera</option>`;
      try{
        const plans = await getPlansIndex();
        plans.sort((a,b)=> (a.nombre||"").localeCompare(b.nombre||"", "es"));
        plans.forEach(p =>{
          const opt = document.createElement("option");
          opt.value = p.slug;
          opt.textContent = p.nombre || p.slug;
          selCareer.appendChild(opt);
        });
        const otherOpt = document.createElement("option");
        otherOpt.value = "otra";
        otherOpt.textContent = "Otra / no listada";
        selCareer.appendChild(otherOpt);
      }catch(e){
        console.error("No pude cargar carreras", e);
      }
    }

    function setMsg(html, isError=false){
      msgBox.style.display = "block";
      msgBox.style.borderStyle = "solid";
      msgBox.style.borderColor = isError ? "rgba(239,68,68,.55)" : "rgba(34,197,94,.45)";
      msgBox.style.background = isError ? "rgba(239,68,68,.08)" : "rgba(34,197,94,.08)";
      msgBox.innerHTML = html;
    }
    function clearMsg(){
      msgBox.style.display = "none";
      msgBox.innerHTML = "";
    }

    function tickClock(){
      const d = new Date();
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      pillClock.textContent = dd + "/" + mm + "/" + yy + " " + hh + ":" + mi + ":" + ss;
    }
    tickClock();
    setInterval(tickClock, 1000);

    // --------- MODO LOGIN / SIGNUP ----------
    let mode = "login";
    const btnModeLogin = document.getElementById("btnModeLogin");
    const btnModeSignup = document.getElementById("btnModeSignup");
    const signupExtra = document.getElementById("signupExtra");
    const btnSubmit = document.getElementById("btnSubmit");

    function setMode(m){
      mode = m;
      clearMsg();
      btnModeLogin.classList.toggle("active", mode === "login");
      btnModeSignup.classList.toggle("active", mode === "signup");
      signupExtra.style.display = (mode === "signup") ? "grid" : "none";
      btnSubmit.textContent = (mode === "signup") ? "Crear cuenta" : "Entrar";
      document.getElementById("inpPass").setAttribute("autocomplete", mode === "signup" ? "new-password" : "current-password");
    }
    btnModeLogin.addEventListener("click", ()=> setMode("login"));
    btnModeSignup.addEventListener("click", ()=> setMode("signup"));

    // --------- TOGGLE PASSWORD ----------
    function wireToggle(btnId, inputId){
      const b = document.getElementById(btnId);
      const i = document.getElementById(inputId);
      if (!b || !i) return;
      b.addEventListener("click", ()=>{
        const isPass = i.type === "password";
        i.type = isPass ? "text" : "password";
        b.textContent = isPass ? "ocultar" : "ver";
      });
    }
    wireToggle("btnTogglePass", "inpPass");
    wireToggle("btnTogglePass2", "inpPass2");

    function isMiUnc(email){
      const e = (email || "").trim().toLowerCase();
      return e.endsWith("@mi.unc.edu.ar");
    }
    function isEmailAddress(value){
      return /\S+@\S+\.\S+/.test((value || "").trim());
    }
    function normalizeDocument(value){
      return (value || "").toString().replace(/\D+/g, "");
    }
    async function findEmailByDocument(documentNumber){
      const docNumber = normalizeDocument(documentNumber);
      if (!docNumber) return null;
      const tryQueries = [
        where("documento","==", docNumber),
        where("dni","==", docNumber),
        where("legajo","==", docNumber)
      ];
      for (const cond of tryQueries){
        const snap = await getDocs(query(collection(db,"users"), cond, limit(1)));
        if (!snap.empty){
          const data = snap.docs[0].data() || {};
          if (data.email) return data.email;
        }
      }
      return null;
    }

    async function ensurePlannerDoc(uid){
      const ref = doc(db, "planner", uid);
      const snap = await getDoc(ref);
      if (snap.exists()) return;
      await setDoc(ref, {
        estudios:{},
        subjects:[],
        agenda:{},
        schedulePresets:[],
        activePresetId:"",
        academico:{}
      }, { merge:true });
    }

    async function getRoleOrStudent(uid){
      try{
        const ref = doc(db, "users", uid);
        const snap = await getDoc(ref);
        if (snap.exists()){
          const role = snap.data()?.role;
          if (role === "admin") return "admin";
        }
      }catch(_e){}
      return "student";
    }

    async function routeUser(user){
      const role = await getRoleOrStudent(user.uid);
      if (role === "admin") window.location.href = "admin.html";
      else window.location.href = "student.html";
    }

    // --------- AUTH ----------
    btnSubmit.addEventListener("click", async ()=>{
      clearMsg();
      const emailInput = (document.getElementById("inpEmail").value || "").trim();
      const pass  = (document.getElementById("inpPass").value || "").trim();
      const pass2 = (document.getElementById("inpPass2").value || "").trim();
      const first = (document.getElementById("inpName").value || "").trim();
      const last  = (document.getElementById("inpLast").value || "").trim();
      const careerSlug= (document.getElementById("inpCareer").value || "").trim();
      const careerOpt = document.getElementById("inpCareer");
      const careerName = careerOpt?.selectedOptions?.[0]?.textContent || careerSlug || "";
      const year  = (document.getElementById("inpYear").value || "").trim();
      const documentoInput = (document.getElementById("inpDocumento").value || "").trim();
      const documento = normalizeDocument(documentoInput);

      if (!emailInput || !pass){
        setMsg("Completá correo o documento y la contraseña.", true);
        return;
      }

      try{
        if (mode === "login"){
          let loginEmail = emailInput;
          if (isEmailAddress(loginEmail)){
            loginEmail = loginEmail.toLowerCase();
          } else {
            setMsg("Buscando tu cuenta por documento…", false);
            const foundEmail = await findEmailByDocument(loginEmail);
            if (!foundEmail){
              setMsg("No encontramos una cuenta con ese documento. Probá con tu correo institucional.", true);
              return;
            }
            loginEmail = foundEmail.toLowerCase();
          }
          await signInWithEmailAndPassword(auth, loginEmail, pass);
          return;
        }

        // signup
        if (!isMiUnc(emailInput)){
          setMsg("Para crear cuenta usá tu correo <strong>@mi.unc.edu.ar</strong>.", true);
          return;
        }
        if (pass.length < 6){
          setMsg("La contraseña debe tener al menos <strong>6 caracteres</strong>.", true);
          return;
        }
        if (pass !== pass2){
          setMsg("Las contraseñas no coinciden.", true);
          return;
        }
        if (!first || !last || !careerSlug){
          setMsg("Completá <strong>Nombre</strong>, <strong>Apellido</strong> y <strong>Carrera</strong>.", true);
          return;
        }
        if (year){
          const y = parseInt(year, 10);
          if (!Number.isFinite(y) || y < 2000 || y > 2100){
            setMsg("El año de ingreso debe ser un número válido (ej: 2024).", true);
            return;
          }
        }

        const cred = await createUserWithEmailAndPassword(auth, emailInput, pass);
        await ensurePlannerDoc(cred.user.uid);
        await setDoc(doc(db,"users",cred.user.uid),{
          email: emailInput.toLowerCase(),
          role:"student",
          firstName:first,
          lastName:last,
          name: (first + " " + last).trim(),
          career: careerName,
          careerSlug: careerSlug,
          yearIn: year ? parseInt(year, 10) : "",
          documento: documento || "",
          dni: documento || "",
          legajo: documento || "",
          createdAt: serverTimestamp()
        }, { merge:true });
        setMsg("Cuenta creada. Entrando…", false);
        await routeUser(cred.user);
      }catch(e){
        const msg = (e && e.message) ? e.message : String(e);
        setMsg("Error: " + msg, true);
      }
    });

    document.getElementById("btnForgot").addEventListener("click", async ()=>{
      clearMsg();
      const emailOrDoc = (document.getElementById("inpEmail").value || "").trim();
      if (!emailOrDoc){
        setMsg("Ingresá tu correo o documento para enviarte el enlace de recuperación.", true);
        return;
      }
      let targetEmail = emailOrDoc;
      if (!isEmailAddress(targetEmail)){
        targetEmail = await findEmailByDocument(emailOrDoc);
      }
      if (targetEmail) targetEmail = targetEmail.toLowerCase();
      if (!targetEmail){
        setMsg("No encontramos una cuenta con esos datos. Probá con tu correo institucional o verificá el documento.", true);
        return;
      }
      try{
        await sendPasswordResetEmail(auth, targetEmail);
        setMsg(
          "Te enviamos un correo de recuperación a <strong>" + targetEmail + "</strong>." +
          "<br>Recibís este mensaje porque se solicitó restablecer la contraseña de tu cuenta." +
          "<br>Si no fuiste vos, podés ignorarlo con tranquilidad." +
          "<br>Tip: revisá la carpeta de spam o promociones."
        , false);
      }catch(e){
        setMsg("Error: " + ((e && e.message) ? e.message : String(e)), true);
      }
    });

    // status pill
    try{
      dotFirebase.classList.remove("warn");
    }catch(_e){}

    // redirect if logged in
    onAuthStateChanged(auth, async (user)=>{
      if (!user) return;
      try{
        await ensurePlannerDoc(user.uid);
      }catch(_e){}
      await routeUser(user);
    });

    // default mode
    loadCareerOptions();
    setMode("login");
    function linkLogo(){
      const aulaVirtual = 'https://fcefyn.aulavirtual.unc.edu.ar' ;
      window.location.href = aulaVirtual
    }
    document.addEventListener('DOMContentLoaded', ()=>{
    const logo =document.getElementById("logoFcefyn");
    if(logo){
      logo.addEventListener('click',linkLogo)
    }
    })
  
  </script>
</body>
</html>
