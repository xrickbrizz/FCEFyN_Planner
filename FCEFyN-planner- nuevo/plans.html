<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Plan de Estudios</title>
<link rel="stylesheet" href="styles/global.css">
<link rel="stylesheet" href="styles/app.css">
<link rel="stylesheet" href="styles/plans.css">
<script src="scripts/ui/theme-toggle.js" defer></script>
</head>

<body class="plans-page">
<header>
  <h1 id="title">Planes de Estudio</h1>
  <div class="right">
    <button class="btn theme-toggle" id="themeToggleBtn" data-theme-toggle type="button">
      <span class="ico"></span><span class="label"></span>
    </button>
    <button class="btn" id="btnBack" type="button">← Volver</button>
    <select id="planSelect">
      <option value="">Elegí plan…</option>
    </select>
    <button class="btn" id="btnReset" type="button">Reiniciar</button>
  </div>
</header>

<div class="msg" id="msg"></div>

<main class="grid-wrap" id="gridWrap" style="display:none;"></main>

<footer>
  <div></div>
  <div>FCEFyN • UNC</div>
</footer>

<div id="statusModal" class="status-modal" hidden aria-hidden="true">
  <div class="status-modal-overlay" data-status-modal-close></div>
  <div class="status-modal-content" role="dialog" aria-modal="true" aria-labelledby="statusModalTitle">
    <div class="status-modal-header">
      <div>
        <h3 id="statusModalTitle">Cambiar estado</h3>
        <p id="statusModalSubject">Seleccioná una materia</p>
      </div>
      <button class="btn status-modal-close" type="button" aria-label="Cerrar modal" data-status-modal-close>×</button>
    </div>
    <div class="status-modal-actions" id="statusModalActions">
      <button class="btn status-option" type="button" data-status-value="promocionada">Promocionada</button>
      <button class="btn status-option" type="button" data-status-value="regular">Regular</button>
      <button class="btn status-option" type="button" data-status-value="libre">Libre</button>
      <button class="btn status-option" type="button" data-status-value="en_curso">En curso</button>
      <button class="btn status-option status-option-remove" type="button" data-status-value="ninguno">Quitar estado</button>
    </div>
  </div>
</div>

<script type="module">
import { showConfirm } from "./scripts/ui/notifications.js";
import { auth, db, collection, getDocs, doc, getDoc, onAuthStateChanged, setDoc, serverTimestamp } from "./scripts/core/firebase.js";
import { resolvePlanSlug, normalizeStr } from "./scripts/plans-data.js";
(function(){
  const STORAGE_KEY_DEFAULT = "estadosMaterias_v2";
  const params = new URLSearchParams(window.location.search);
  const embed = params.get("embed") === "1";
  const lock = params.get("lock") === "1";
  const slugParam = params.get("career") || params.get("slug") || "";

  if (embed) document.body.classList.add("plans-embed");

  const title = document.getElementById("title");
  const msg = document.getElementById("msg");
  const gridWrap = document.getElementById("gridWrap");
  const statusModal = document.getElementById("statusModal");
  const statusModalSubject = document.getElementById("statusModalSubject");
  const statusModalActions = document.getElementById("statusModalActions");

  const btnBack = document.getElementById("btnBack");
  const btnReset = document.getElementById("btnReset");
  const planSelect = document.getElementById("planSelect");

  if (lock && planSelect) planSelect.disabled = true;

  const labels = [
    "Ingreso","1º Semestre","2º Semestre","3º Semestre",
    "4º Semestre","5º Semestre","6º Semestre","7º Semestre",
    "8º Semestre","9º Semestre","10º Semestre"
  ];

  function normalize(s){
    return normalizeStr(s);
  }

  function slugify(value){
    return normalizeStr(value)
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/(^-|-$)/g, "");
  }

  function showMsg(text){
    msg.style.display = "block";
    msg.textContent = text;
  }
  function hideMsg(){
    msg.style.display = "none";
    msg.textContent = "";
  }

  function getBackUrl(){
    const from = localStorage.getItem("plans_from_url");
    return from && typeof from === "string" ? from : "plans_index.html";
  }

  let storageKey = STORAGE_KEY_DEFAULT;
  let plannerUid = "";
  let plannerRef = null;
  let subjectStates = {};
  let selectedSubjectId = "";
  let previousFocusedElement = null;

  function normalizeStatus(statusValue){
    const raw = typeof statusValue === "string" ? normalize(statusValue) : "";
    if (!raw) return null;
    if (raw === "promocionada" || raw === "promocion") return "promocionada";
    if (raw === "regular") return "regular";
    if (raw === "libre") return "libre";
    if (raw === "en_curso" || raw === "curso" || raw === "encurso") return "en_curso";
    return null;
  }

  function isApproved(status){
    const normalized = normalizeStatus(status);
    return normalized === "promocionada" || normalized === "regular";
  }

  function getSubjectStatus(slug){
    const safeSlug = String(slug || "").trim();
    if (!safeSlug){
      console.warn("[plans] getSubjectStatus recibió subjectSlug vacío.");
      return null;
    }
    return normalizeStatus(subjectStates?.[safeSlug]?.status);
  }

  function getSubjectApproved(slug){
    return isApproved(getSubjectStatus(slug));
  }

  function getLegacyStates(){
    try{ return JSON.parse(localStorage.getItem(storageKey) || "{}"); }
    catch{ return {}; }
  }

  function getEstados(){
    const estados = {};
    Object.keys(subjectStates || {}).forEach((slug) => {
      const status = normalizeStatus(subjectStates?.[slug]?.status);
      if (status) estados[slug] = status;
    });
    return estados;
  }
  function setEstados(obj){
    localStorage.setItem(storageKey, JSON.stringify(obj || {}));

    const nextStates = { ...(subjectStates || {}) };
    Object.entries(obj || {}).forEach(([slug, status]) => {
      const normalizedSlug = String(slug || "").trim();
      const normalizedStatus = normalizeStatus(status);
      if (!normalizedSlug || !normalizedStatus) return;
      nextStates[normalizedSlug] = {
        ...(nextStates[normalizedSlug] || {}),
        status: normalizedStatus,
        approved: isApproved(normalizedStatus)
      };
    });
    Object.keys(nextStates).forEach((slug) => {
      if (!(slug in (obj || {}))){
        nextStates[slug] = {
          ...(nextStates[slug] || {}),
          status: null,
          approved: false
        };
      }
    });
    subjectStates = nextStates;
  }

  async function updateSubjectState(slug, status){
    const normalizedSlug = String(slug || "").trim();
    if (!normalizedSlug){
      console.warn("[plans] No se puede guardar estado: falta subjectSlug.");
      return;
    }

    const normalizedStatus = normalizeStatus(status);
    const approved = isApproved(normalizedStatus);
    const payload = {
      status: normalizedStatus,
      approved,
      updatedAt: serverTimestamp()
    };

    subjectStates = {
      ...(subjectStates || {}),
      [normalizedSlug]: payload
    };

    if (!plannerRef){
      console.warn("[plans] plannerRef no disponible; se guarda solo en cache local.");
      return;
    }

    await setDoc(plannerRef, {
      subjectStates: {
        [normalizedSlug]: payload
      }
    }, { merge: true });
  }

  async function loadSubjectStatesFromPlanner(){
    if (!plannerRef){
      console.warn("[plans] No se puede cargar subjectStates: plannerRef ausente.");
      return;
    }

    const plannerSnap = await getDoc(plannerRef);
    if (!plannerSnap.exists()){
      console.warn("[plans] planner/{uid} no existe; se inicializa subjectStates vacío.");
      subjectStates = {};
      return;
    }

    const plannerData = plannerSnap.data() || {};
    if (!plannerData.subjectStates || typeof plannerData.subjectStates !== "object"){
      console.warn("[plans] planner.subjectStates no existe o no es mapa; se usa fallback local.");
      subjectStates = {};
      return;
    }

    subjectStates = plannerData.subjectStates;
  }

  function hydrateSubjectStatesFromLegacy(){
    const legacyStates = getLegacyStates();
    if (!legacyStates || typeof legacyStates !== "object") return;

    const hasRemoteStates = Object.keys(subjectStates || {}).length > 0;
    if (hasRemoteStates) return;

    Object.entries(legacyStates).forEach(([slug, status]) => {
      const normalizedSlug = String(slug || "").trim();
      const normalizedStatus = normalizeStatus(status);
      if (!normalizedSlug || !normalizedStatus) return;
      subjectStates[normalizedSlug] = {
        status: normalizedStatus,
        approved: isApproved(normalizedStatus)
      };
    });
  }

  let indexPlans = [];
  let materias = [];

  function buildGrid(){
    gridWrap.innerHTML = "";
    let statsPanelCell = null;
    for(let i=0;i<12;i++){
      const cell = document.createElement("section");
      cell.className = "cell";
      if(i < labels.length){
        cell.innerHTML = `<h2>${labels[i]}</h2><div class="subjects" data-sem="${i+1}"></div>`;
      }else{
        cell.innerHTML = `<h2>Panel de estadísticas</h2>
          <div class="stats" id="panelStats">
            <div class="stats-grid">
              <div class="stat-card"><strong id="countProm">0</strong><div class="stat-label">Promocionadas</div></div>
              <div class="stat-card"><strong id="countReg">0</strong><div class="stat-label">Regulares</div></div>
              <div class="stat-card"><strong id="countLib">0</strong><div class="stat-label">Libres</div></div>
              <div class="stat-card"><strong id="countCur">0</strong><div class="stat-label">En curso</div></div>
            </div>

            <div class="stats-meta">
              <div class="progress-wrap">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                  <div style="color:var(--muted); font-size:0.85rem;">Progreso de la carrera</div>
                  <div style="color:var(--muted); font-size:0.85rem;" id="pctText">0,00%</div>
                </div>
                <div class="progress" aria-hidden="true" style="margin-top:8px;">
                  <div class="fill" id="progressFill" style="width:0%"></div>
                </div>
                <div class="progress-caption">
                  <div id="captionLeft">0 materias promocionadas</div>
                  <div id="totalMateriasText"></div>
                </div>
              </div>

              <div style="display:flex; gap:8px; justify-content:space-between; align-items:center;">
                <button class="btn" id="btnResetPanel" type="button" title="Borrar todos los estados">Resetear estados</button>
                <div style="color:var(--muted); font-size:0.85rem;">Cambios guardados automáticamente</div>
              </div>
            </div>
          </div>`;
        statsPanelCell = cell;
      }
      gridWrap.appendChild(cell);
    }

    if (statsPanelCell && statsPanelCell.parentNode === gridWrap){
      gridWrap.prepend(statsPanelCell);
    }

    const btnResetPanel = document.getElementById("btnResetPanel");
    if(btnResetPanel){
      btnResetPanel.addEventListener("click", async ()=>{
        const ok = await showConfirm({
          title:"Reiniciar panel",
          message:"¿Borrar todos los estados?",
          confirmText:"Resetear",
          cancelText:"Cancelar",
          danger:true
        });
        if(!ok) return;
        const previousSlugs = Object.keys(getEstados());
        localStorage.removeItem(storageKey);
        setEstados({});
        for (const slug of previousSlugs){
          try{
            await updateSubjectState(slug, null);
          }catch(error){
            console.error("[plans] Error limpiando subjectState en Firestore:", slug, error);
          }
        }
        updateUI();
      });
    }
  }

  function placeSubjects(){
    document.querySelectorAll(".subjects").forEach(s => s.innerHTML = "");
    let renderizadas = 0;
    let sinSemestreValido = 0;
    materias.forEach(m=>{
      const container = document.querySelector(`.subjects[data-sem='${m.semestre}']`);
      if(!container){
        sinSemestreValido++;
        console.warn("[plans] materia sin contenedor", m.id, m.semestre, m);
        return;
      }
      const d = document.createElement("div");
      d.className = "subject";
      d.textContent = m.nombre;
      d.dataset.id = m.id;
      d.dataset.subjectSlug = m.id;
      container.appendChild(d);
      renderizadas++;
    });
    console.log("[plans] materias renderizadas:", renderizadas, "sin semestre válido:", sinSemestreValido);
  }

  function porcentajePromocionadas(){
    const estados = getEstados();
    const total = materias.filter(m => m.id !== "practica").length || 1;
    const promo = Object.values(estados).filter(e => e === "promocionada").length;
    return (promo / total) * 100;
  }

  function porcentajeAprobadas(excludeId){
    const estados = getEstados();
    const total = materias.filter(m => m.id !== "practica" && m.id !== excludeId).length || 1;
    let aprobadas = 0;

    Object.entries(estados).forEach(([id, st])=>{
      if(id === "practica") return;
      if(excludeId && id === excludeId) return;
      if(isApproved(st)) aprobadas++;
    });

    return (aprobadas / total) * 100;
  }

  function updateStatsUI(){
    const estados = getEstados();
    const counts = { promocionada:0, regular:0, libre:0, en_curso:0 };
    Object.values(estados).forEach(v => { if(counts[v] !== undefined) counts[v]++; });

    const total = materias.filter(m => m.id !== "practica").length || 1;
    let aprobadas = 0;
    Object.entries(estados).forEach(([id, st])=>{
      if(id === "practica") return;
      if(isApproved(st)) aprobadas++;
    });
    const pct = (aprobadas / total) * 100;

    const elProm = document.getElementById("countProm");
    const elReg  = document.getElementById("countReg");
    const elLib  = document.getElementById("countLib");
    const elCur  = document.getElementById("countCur");
    if(elProm) elProm.textContent = counts.promocionada;
    if(elReg)  elReg.textContent  = counts.regular;
    if(elLib)  elLib.textContent  = counts.libre;
    if(elCur)  elCur.textContent  = counts.en_curso;

    const pctText = document.getElementById("pctText");
    const fill = document.getElementById("progressFill");
    const captionLeft = document.getElementById("captionLeft");
    const totalText = document.getElementById("totalMateriasText");

    if(pctText) pctText.textContent = pct.toFixed(2).replace(".", ",") + "%";
    if(fill) fill.style.width = Math.min(pct, 100) + "%";
    if(captionLeft) captionLeft.textContent = aprobadas + " materias aprobadas/regularizadas";
    if(totalText) totalText.textContent = total + " materias totales";
  }
async function revalidateEstados() {
  const estados = getEstados();
  let changed = true;

  while (changed) {
    changed = false;

    materias.forEach(mat => {
      const estadoActual = estados[mat.id];
      if (!estadoActual) return;

      let invalida = false;

      // requisito por porcentaje
      if (mat.requierePorcentaje) {
        if (porcentajeAprobadas(mat.id) < mat.requierePorcentaje) {
          invalida = true;
        }
      }

      // requisito por cantidad aprobadas
      if (!invalida && mat.requiereAprobadas) {
        const aprobadas = Object.values(estados)
          .filter(e => isApproved(e)).length;
        if (aprobadas < mat.requiereAprobadas) {
          invalida = true;
        }
      }

      // requisito por correlativas
      if (
        !invalida &&
        Array.isArray(mat.requisitos) &&
        mat.requisitos.length
      ) {
        const faltan = mat.requisitos.some(r => {
          const est = estados[r];
          return !isApproved(est);
        });
        if (faltan) invalida = true;
      }

      // si quedó inválida → quitar estado
      if (invalida) {
        estados[mat.id] = null;
        changed = true;
      }
    });
  }

  setEstados(estados);
  const updates = Object.entries(estados)
    .filter(([, status]) => normalizeStatus(status) === null)
    .map(([slug]) => updateSubjectState(slug, null).catch((error) => {
      console.error("[plans] Error al revalidar estado en Firestore:", slug, error);
    }));
  await Promise.all(updates);
}

  function updateUI(){
    const estados = getEstados();
    document.querySelectorAll(".subject").forEach(el=>{
      const id = el.dataset.id;
      el.className = "subject";
      const mat = materias.find(x=>x.id===id);
      const estado = estados[id];
      let bloqueada = false;

      if(mat && mat.requierePorcentaje){
        if(porcentajeAprobadas(mat.id) < mat.requierePorcentaje) bloqueada = true;
      }else if(mat && mat.requiereAprobadas){
        const aprobadas = Object.values(estados).filter(e => isApproved(e)).length;
        if(aprobadas < mat.requiereAprobadas) bloqueada = true;
      }else if(mat && Array.isArray(mat.requisitos) && mat.requisitos.length){
        const faltan = mat.requisitos.filter(r=>{
          const est = estados[r];
          return !isApproved(est);
        });
        if(faltan.length) bloqueada = true;
      }

      if(bloqueada && !estado) el.classList.add("locked");
      if(estado) el.classList.add(estado);
      el.classList.toggle("subject-approved", getSubjectApproved(id));
      el.dataset.approved = getSubjectApproved(id) ? "true" : "false";
    });

    updateStatsUI();
  }

function openStatusModal(subjectId, subjectName){
  if (!statusModal) return;

  selectedSubjectId = String(subjectId || "").trim();
  if (!selectedSubjectId){
    console.warn("[plans] No se puede abrir modal de estado: falta subjectSlug.");
    return;
  }

  // ✅ Guardar también en el modal (fuente de verdad)
  statusModal.dataset.subjectSlug = selectedSubjectId;

  previousFocusedElement = document.activeElement;
  statusModalSubject.textContent = subjectName ? `Materia: ${subjectName}` : "Materia seleccionada";
  statusModal.hidden = false;
  statusModal.setAttribute("aria-hidden", "false");
  document.body.classList.add("status-modal-open");

  const firstOption = statusModalActions?.querySelector(".status-option");
  if (firstOption) firstOption.focus();
}
function closeStatusModal(){
  if (!statusModal) return;
  statusModal.hidden = true;
  statusModal.setAttribute("aria-hidden", "true");
  document.body.classList.remove("status-modal-open");

  selectedSubjectId = "";
  delete statusModal.dataset.subjectSlug; // ✅

  if (previousFocusedElement && typeof previousFocusedElement.focus === "function"){
    previousFocusedElement.focus();
  }
  previousFocusedElement = null;
}
async function applyStatus(statusValue, triggerButton){
  const slugFromModal = statusModal?.dataset?.subjectSlug || "";
  const slug = String(selectedSubjectId || slugFromModal || "").trim();

  if (!slug){
    console.warn("[plans] No se puede actualizar estado: falta subjectSlug seleccionado.");
    return;
  }

  const estados = getEstados();
  estados[slug] = statusValue === "ninguno" ? null : normalizeStatus(statusValue);
  setEstados(estados);

  if (triggerButton){
    triggerButton.classList.add("is-selected");
    setTimeout(() => triggerButton.classList.remove("is-selected"), 150);
  }

  try{
  try {
  if (!plannerRef) {
    console.warn("[plans] plannerRef no disponible; se guarda solo en cache local.");
  } else {
    const normalizedStatus = normalizeStatus(estados[slug]);
    const payload = {
      status: normalizedStatus,
      approved: isApproved(normalizedStatus),
      updatedAt: serverTimestamp()
    };

    await setDoc(plannerRef, {
      subjectStates: {
        [slug]: payload
      }
    }, { merge: true });

    // opcional: mantener en memoria sincronizado
    subjectStates = { ...(subjectStates || {}), [slug]: payload };
  }
} catch (error) {
  console.error("[plans] Error guardando subjectStates en Firestore:", error);
}
  }catch(error){
    console.error("[plans] Error guardando subjectStates en Firestore:", error);
  }

  await revalidateEstados();
  closeStatusModal();
  updateUI();
}
  function attachEventsToSubjects(){
    document.querySelectorAll(".subject").forEach(el=>{
      el.onclick = (e)=>{
        const subjectSlug = el.dataset.subjectSlug || el.dataset.id;
        const estados = getEstados();
        if(el.classList.contains("locked") && !estados[subjectSlug]) return;
        openStatusModal(subjectSlug, el.textContent || "Materia");
      };
    });
  }

  if (statusModalActions){
    statusModalActions.querySelectorAll("[data-status-value]").forEach((button) => {
      button.addEventListener("click", async () => {
        await applyStatus(button.dataset.statusValue, button);
      });
    });
  }

  if (statusModal){
    statusModal.addEventListener("click", (event) => {
      const shouldClose = event.target instanceof HTMLElement && event.target.hasAttribute("data-status-modal-close");
      if (shouldClose) closeStatusModal();
    });
  }

  window.addEventListener("keydown", (event) => {
    if (event.key === "Escape" && statusModal && !statusModal.hidden){
      closeStatusModal();
    }
  });

  function detectMaterias(data){
    if(Array.isArray(data)) return data;
    if(data && Array.isArray(data.materias)) return data.materias;
    if(data && Array.isArray(data.subjects)) return data.subjects;
    return [];
  }

  function parseSemestre(value){
    if(value === null || value === undefined) return null;
    if(typeof value === "number" && Number.isFinite(value)) return value;
    if(typeof value === "string"){
      const trimmed = value.trim();
      if(!trimmed) return null;
      if(/^\d+$/.test(trimmed)) return Number(trimmed);
    }
    return null;
  }

  function isIngresoMateria(raw){
    const values = [
      raw?.semestre,
      raw?.semester,
      raw?.cuatrimestre,
      raw?.term,
      raw?.nivel,
      raw?.tag,
      raw?.tags,
      raw?.category,
      raw?.categoria,
      raw?.tipo,
      raw?.level
    ];

    return values.some((value) => {
      if(Array.isArray(value)){
        return value.some((item) => normalize(String(item || "")).includes("ingreso"));
      }
      return normalize(String(value || "")).includes("ingreso");
    });
  }

  function normalizeRequisitos(value){
    if(!value) return [];

    const toReqId = (item) => {
      if(item === null || item === undefined) return "";
      if(typeof item === "string" || typeof item === "number") return String(item).trim();
      if(typeof item === "object"){
        return String(
          item.id || item.slug || item.subjectSlug || item.subjectId || item.codigo || item.code || ""
        ).trim();
      }
      return "";
    };

    const list = typeof value === "string"
      ? value.split(",")
      : Array.isArray(value)
        ? value
        : [value];

    return list.map(toReqId).filter(Boolean);
  }

  function normalizeMateria(raw){
    const materia = raw && typeof raw === "object" ? raw : {};
    let semestre = parseSemestre(
      materia.semestre ?? materia.semester ?? materia.cuatrimestre ?? materia.term ?? materia.nivel
    );

    if(semestre === null){
      semestre = isIngresoMateria(materia) ? 1 : 2;
    }

    const nombre = materia.nombre || materia.name || materia.subjectName || materia.title || "(Sin nombre)";
    const subjectSlug = materia.id || materia.slug || materia.subjectSlug || materia.subjectId || slugify(nombre);
    if (!subjectSlug){
      console.warn("[plans] Materia sin subjectSlug detectada:", materia);
    }

    return {
      id: subjectSlug,
      nombre,
      semestre,
      requisitos: normalizeRequisitos(
        materia.requisitos ?? materia.prerequisites ?? materia.correlativas ?? materia.requires ?? []
      ),
      requiereAprobadas: materia.requiereAprobadas ?? materia.requiresApprovedCount ?? materia.minApproved ?? null,
      requierePorcentaje: materia.requierePorcentaje ?? materia.requiresPercentage ?? materia.minPercent ?? null
    };
  }

  function normalizeMaterias(list){
    if(!Array.isArray(list)) return [];
    return list.map(normalizeMateria);
  }

  const aliasMap = new Map();

  function registerAlias(alias, realSlug){
    const normalizedAlias = normalize(alias);
    const normalizedReal = normalize(realSlug);
    if (!normalizedAlias || !normalizedReal || aliasMap.has(normalizedAlias)) return;
    aliasMap.set(normalizedAlias, realSlug);
  }

  function buildAliasMap(plans){
    aliasMap.clear();
    (plans || []).forEach((plan) => {
      const realSlug = (plan.slug || "").trim();
      if (!realSlug) return;

      const resolvedSlug = resolvePlanSlug(realSlug);
      const nameSlug = slugify(plan.nombre || "");

      registerAlias(realSlug, realSlug);
      registerAlias(resolvedSlug, realSlug);
      registerAlias(nameSlug, realSlug);

      if (nameSlug){
        registerAlias(`ingenieria-${nameSlug}`, realSlug);
        registerAlias(`ingenieria-en-${nameSlug}`, realSlug);
      }

      if (resolvedSlug){
        registerAlias(`ingenieria-${resolvedSlug}`, realSlug);
        registerAlias(`ingenieria-en-${resolvedSlug}`, realSlug);
      }
    });
  }

  function findPlanInIndex(slugInput){
    const normalizedInput = normalize(slugInput);
    return indexPlans.find((plan) => normalize(plan.slug) === normalizedInput) || null;
  }

  function resolvePlanDocId(slugInput){
    const attempts = [];
    const addAttempt = (value) => {
      const normalizedValue = normalize(value);
      if (!normalizedValue) return;
      if (!attempts.includes(normalizedValue)) attempts.push(normalizedValue);
    };

    const rawSlug = String(slugInput || "");
    const resolvedSlug = resolvePlanSlug(rawSlug);

    addAttempt(rawSlug);
    addAttempt(resolvedSlug);

    if (resolvedSlug){
      addAttempt(`ingenieria-${resolvedSlug}`);
      addAttempt(`ingenieria-en-${resolvedSlug}`);
    }

    let resolvedDocId = "";
    for (const attempt of attempts){
      const fromAlias = aliasMap.get(attempt);
      if (fromAlias){
        resolvedDocId = fromAlias;
        break;
      }

      const fromIndex = findPlanInIndex(attempt);
      if (fromIndex?.slug){
        resolvedDocId = fromIndex.slug;
        break;
      }
    }

    return { resolvedDocId, attempts };
  }

async function updateSubjectState(slug, status){
  const normalizedSlug = String(slug || "").trim();
  if (!normalizedSlug){
    console.warn("[plans] No se puede guardar estado: falta subjectSlug.");
    return;
  }

  const normalizedStatus = normalizeStatus(status);
  const payload = {
    status: normalizedStatus,
    approved: isApproved(normalizedStatus),
    updatedAt: serverTimestamp()
  };

  // memoria local
  subjectStates = { ...(subjectStates || {}), [normalizedSlug]: payload };

  // firestore
  if (!plannerRef){
    console.warn("[plans] plannerRef no disponible; se guarda solo en cache local.");
    return;
  }

  await setDoc(plannerRef, {
    subjectStates: { [normalizedSlug]: payload }
  }, { merge: true });
}


  async function loadPlans(){
    const snapshot = await getDocs(collection(db, "plans"));
    return snapshot.docs.map((snap) => ({
      id: snap.id,
      ...snap.data()
    }));
  }

  async function loadPlan(slug){
    const snap = await getDoc(doc(db, "plans", slug));
    if (!snap.exists()) {
      throw new Error("Plan no encontrado");
    }
    return { id: snap.id, ...snap.data() };
  }

  async function loadIndex(){
    const plans = await loadPlans();
    indexPlans = (Array.isArray(plans) ? plans : []).map((plan) => ({
      slug: plan.slug || plan.id || "",
      nombre: plan.nombre || plan.slug || plan.id || "Sin nombre",
      version: Number(plan.version || 1)
    })).filter((plan) => !!plan.slug).sort((a,b)=>{
      return normalize(a.nombre).localeCompare(normalize(b.nombre), "es");
    });

    buildAliasMap(indexPlans);

    planSelect.innerHTML = `<option value="">Elegí plan…</option>`;
    indexPlans.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p.slug || "";
      opt.textContent = p.nombre || p.slug || "Sin nombre";
      planSelect.appendChild(opt);
    });
  }

  async function loadPlanBySlug(slugInput){
    const rawSlug = String(slugInput || "");
    const resolvedSlug = resolvePlanSlug(rawSlug);
    const { resolvedDocId, attempts } = resolvePlanDocId(rawSlug);

    console.log("[plans] slug recibido:", rawSlug);
    console.log("[plans] slug resuelto:", resolvedSlug);

    if(!resolvedDocId){
      gridWrap.style.display = "none";
      title.textContent = "Planes de Estudio";
      const examples = indexPlans.slice(0, 3).map((plan) => plan.slug).filter(Boolean).join(", ") || "(sin planes disponibles)";
      showMsg(`No se encontró el plan para slug: ${rawSlug}. Probé: [${attempts.join(", ")}]. Planes disponibles: ${examples}`);
      return;
    }

    hideMsg();

    const plan = findPlanInIndex(resolvedDocId);
    const planData = await loadPlan(resolvedDocId);
    const planSlug = planData.slug || planData.id || plan?.slug || resolvedDocId;
    storageKey = `${STORAGE_KEY_DEFAULT}_${planSlug}`;

    materias = normalizeMaterias(detectMaterias(planData));
    console.log("[plans] docId final usado:", resolvedDocId);
    console.log("[plans] cantidad de materias detectadas:", Array.isArray(materias) ? materias.length : 0);

    if(!Array.isArray(materias) || !materias.length){
      gridWrap.style.display = "none";
      showMsg(`El plan ${resolvedDocId} no tiene materias válidas para mostrar.`);
      return;
    }

    title.textContent = planData.nombre || plan?.nombre || "Plan de Estudios";
    gridWrap.style.display = "grid";

    buildGrid();
    placeSubjects();
    attachEventsToSubjects();
    updateUI();

    sessionStorage.setItem("selectedPlanSlug", planSlug || "");
    sessionStorage.setItem("selectedPlanNombre", planData.nombre || plan?.nombre || "");
    planSelect.value = planSlug || resolvedDocId || "";
  }


  btnBack.addEventListener("click", ()=> window.location.href = getBackUrl());

  btnReset.addEventListener("click", async ()=>{
    const ok = await showConfirm({
      title:"Reiniciar estados",
      message:"¿Querés reiniciar todos los estados? Esta acción no se puede deshacer.",
      confirmText:"Reiniciar",
      cancelText:"Cancelar",
      danger:true
    });
    if(!ok) return;
    const previousSlugs = Object.keys(getEstados());
    localStorage.removeItem(storageKey);
    setEstados({});
    for (const slug of previousSlugs){
      try{
        await updateSubjectState(slug, null);
      }catch(error){
        console.error("[plans] Error limpiando subjectState en Firestore:", slug, error);
      }
    }
    updateUI();
  });

  planSelect.addEventListener("change", ()=>{
    const slug = planSelect.value;
    if(!slug){
      gridWrap.style.display = "none";
      title.textContent = "Planes de Estudio";
      showMsg("Elegí una carrera para abrir su plan.");
      storageKey = STORAGE_KEY_DEFAULT;
      return;
    }
    loadPlanBySlug(slug).catch(e=>{
      gridWrap.style.display = "none";
      showMsg("Error al cargar el plan: " + (e && e.message ? e.message : e));
    });
  });

  window.addEventListener("storage", (e)=>{ if(e.key === storageKey){ hydrateSubjectStatesFromLegacy(); updateUI(); } });

  async function initPlansPage(){
    try{
      await new Promise((resolve) => {
        const unsub = onAuthStateChanged(auth, (user) => {
          unsub();
          plannerUid = user?.uid || "";
          plannerRef = plannerUid ? doc(db, "planner", plannerUid) : null;
          if (!plannerUid) console.warn("[plans] Usuario sin sesión: subjectStates se mantiene en cache local.");
          resolve();
        }, () => resolve());
      });
      await loadSubjectStatesFromPlanner();
      hydrateSubjectStatesFromLegacy();
      await loadIndex();

      // 1) query string directo (modo embebido o link directo)
      if (slugParam){
        await loadPlanBySlug(slugParam);
        return;
      }

      // 2) si venís desde plans_index.html o app.html sin query string, uso sessionStorage
      const saved = sessionStorage.getItem("selectedPlanSlug") || "";
      if(saved){
        await loadPlanBySlug(saved);
        return;
      }

      // 3) si no hay nada seleccionado, muestro mensaje
      gridWrap.style.display = "none";
      title.textContent = "Planes de Estudio";
      showMsg("Elegí una carrera para abrir su plan.");
    }catch(e){
      gridWrap.style.display = "none";
      showMsg("Error al cargar el índice desde Firestore: " + (e && e.message ? e.message : e));
    }
  }

  document.addEventListener("DOMContentLoaded", async () => {
    await initPlansPage();
  });
})();
</script>
</body>
</html>
