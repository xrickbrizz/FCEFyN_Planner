<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Plan de Estudios</title>
<link rel="stylesheet" href="styles/global.css">
<link rel="stylesheet" href="styles/app.css">
<link rel="stylesheet" href="styles/plans.css">
<script src="scripts/ui/theme-toggle.js" defer></script>
</head>

<body class="plans-page">
<header>
  <h1 id="title">Planes de Estudio</h1>
  <div class="right">
    <button class="btn theme-toggle" id="themeToggleBtn" data-theme-toggle type="button">
      <span class="ico"></span><span class="label"></span>
    </button>
    <button class="btn" id="btnBack" type="button">‚Üê Volver</button>
    <select id="planSelect">
      <option value="">Eleg√≠ plan‚Ä¶</option>
    </select>
    <button class="btn" id="btnReset" type="button">Reiniciar</button>
  </div>
</header>

<div class="msg" id="msg"></div>

<main class="grid-wrap" id="gridWrap" style="display:none;"></main>

<footer>
  <div></div>
  <div>FCEFyN ‚Ä¢ UNC</div>
</footer>

<div id="menu" style="display:none; position:fixed; z-index:9999;"></div>

<script type="module">
import { showConfirm } from "./scripts/ui/notifications.js";
import { db, collection, getDocs, doc, getDoc } from "./scripts/core/firebase.js";
import { resolvePlanSlug, normalizeStr } from "./scripts/plans-data.js";
(function(){
  const STORAGE_KEY_DEFAULT = "estadosMaterias_v2";
  const params = new URLSearchParams(window.location.search);
  const embed = params.get("embed") === "1";
  const lock = params.get("lock") === "1";
  const slugParam = params.get("career") || params.get("slug") || "";

  if (embed) document.body.classList.add("plans-embed");

  const title = document.getElementById("title");
  const msg = document.getElementById("msg");
  const gridWrap = document.getElementById("gridWrap");
  const menu = document.getElementById("menu");

  const btnBack = document.getElementById("btnBack");
  const btnReset = document.getElementById("btnReset");
  const planSelect = document.getElementById("planSelect");

  if (lock && planSelect) planSelect.disabled = true;

  const labels = [
    "Ingreso","1¬∫ Semestre","2¬∫ Semestre","3¬∫ Semestre",
    "4¬∫ Semestre","5¬∫ Semestre","6¬∫ Semestre","7¬∫ Semestre",
    "8¬∫ Semestre","9¬∫ Semestre","10¬∫ Semestre"
  ];

  function normalize(s){
    return normalizeStr(s);
  }

  function slugify(value){
    return normalizeStr(value)
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/(^-|-$)/g, "");
  }

  function showMsg(text){
    msg.style.display = "block";
    msg.textContent = text;
  }
  function hideMsg(){
    msg.style.display = "none";
    msg.textContent = "";
  }

  function getBackUrl(){
    const from = localStorage.getItem("plans_from_url");
    return from && typeof from === "string" ? from : "plans_index.html";
  }

  let storageKey = STORAGE_KEY_DEFAULT;

  function getEstados(){
    try{ return JSON.parse(localStorage.getItem(storageKey) || "{}"); }
    catch{ return {}; }
  }
  function setEstados(obj){
    localStorage.setItem(storageKey, JSON.stringify(obj));
  }

  let indexPlans = [];
  let materias = [];

  function buildGrid(){
    gridWrap.innerHTML = "";
    for(let i=0;i<12;i++){
      const cell = document.createElement("section");
      cell.className = "cell";
      if(i < labels.length){
        cell.innerHTML = `<h2>${labels[i]}</h2><div class="subjects" data-sem="${i+1}"></div>`;
      }else{
        cell.innerHTML = `<h2>Panel de estad√≠sticas</h2>
          <div class="stats" id="panelStats">
            <div class="stat-row">
              <div class="stat-card"><strong id="countProm">0</strong><div class="stat-label">Promocionadas</div></div>
              <div class="stat-card"><strong id="countReg">0</strong><div class="stat-label">Regulares</div></div>
            </div>
            <div class="stat-row">
              <div class="stat-card"><strong id="countLib">0</strong><div class="stat-label">Libres</div></div>
              <div class="stat-card"><strong id="countCur">0</strong><div class="stat-label">En curso</div></div>
            </div>

            <div class="progress-wrap">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                <div style="color:var(--muted); font-size:0.85rem;">Progreso de la carrera</div>
                <div style="color:var(--muted); font-size:0.85rem;" id="pctText">0,00%</div>
              </div>
              <div class="progress" aria-hidden="true" style="margin-top:8px;">
                <div class="fill" id="progressFill" style="width:0%"></div>
              </div>
              <div class="progress-caption">
                <div id="captionLeft">0 materias promocionadas</div>
                <div id="totalMateriasText"></div>
              </div>
            </div>

            <div style="display:flex; gap:8px; justify-content:space-between; align-items:center;">
              <button class="btn" id="btnResetPanel" type="button" title="Borrar todos los estados">Resetear estados</button>
              <div style="color:var(--muted); font-size:0.85rem;">Cambios guardados autom√°ticamente</div>
            </div>
          </div>`;
      }
      gridWrap.appendChild(cell);
    }

    const btnResetPanel = document.getElementById("btnResetPanel");
    if(btnResetPanel){
      btnResetPanel.addEventListener("click", async ()=>{
        const ok = await showConfirm({
          title:"Reiniciar panel",
          message:"¬øBorrar todos los estados?",
          confirmText:"Resetear",
          cancelText:"Cancelar",
          danger:true
        });
        if(!ok) return;
        localStorage.removeItem(storageKey);
        updateUI();
      });
    }
  }

  function placeSubjects(){
    document.querySelectorAll(".subjects").forEach(s => s.innerHTML = "");
    materias.forEach(m=>{
      const container = document.querySelector(`.subjects[data-sem='${m.semestre}']`);
      if(!container) return;
      const d = document.createElement("div");
      d.className = "subject";
      d.textContent = m.nombre;
      d.dataset.id = m.id;
      container.appendChild(d);
    });
  }

  function porcentajePromocionadas(){
    const estados = getEstados();
    const total = materias.filter(m => m.id !== "practica").length || 1;
    const promo = Object.values(estados).filter(e => e === "promocion").length;
    return (promo / total) * 100;
  }

  function porcentajeAprobadas(excludeId){
    const estados = getEstados();
    const total = materias.filter(m => m.id !== "practica" && m.id !== excludeId).length || 1;
    let aprobadas = 0;

    Object.entries(estados).forEach(([id, st])=>{
      if(id === "practica") return;
      if(excludeId && id === excludeId) return;
      if(st === "promocion" || st === "regular") aprobadas++;
    });

    return (aprobadas / total) * 100;
  }

  function updateStatsUI(){
    const estados = getEstados();
    const counts = { promocion:0, regular:0, libre:0, curso:0 };
    Object.values(estados).forEach(v => { if(counts[v] !== undefined) counts[v]++; });

    const total = materias.filter(m => m.id !== "practica").length || 1;
    let aprobadas = 0;
    Object.entries(estados).forEach(([id, st])=>{
      if(id === "practica") return;
      if(st === "promocion" || st === "regular") aprobadas++;
    });
    const pct = (aprobadas / total) * 100;

    const elProm = document.getElementById("countProm");
    const elReg  = document.getElementById("countReg");
    const elLib  = document.getElementById("countLib");
    const elCur  = document.getElementById("countCur");
    if(elProm) elProm.textContent = counts.promocion;
    if(elReg)  elReg.textContent  = counts.regular;
    if(elLib)  elLib.textContent  = counts.libre;
    if(elCur)  elCur.textContent  = counts.curso;

    const pctText = document.getElementById("pctText");
    const fill = document.getElementById("progressFill");
    const captionLeft = document.getElementById("captionLeft");
    const totalText = document.getElementById("totalMateriasText");

    if(pctText) pctText.textContent = pct.toFixed(2).replace(".", ",") + "%";
    if(fill) fill.style.width = Math.min(pct, 100) + "%";
    if(captionLeft) captionLeft.textContent = aprobadas + " materias aprobadas/regularizadas";
    if(totalText) totalText.textContent = total + " materias totales";
  }
function revalidateEstados() {
  const estados = getEstados();
  let changed = true;

  while (changed) {
    changed = false;

    materias.forEach(mat => {
      const estadoActual = estados[mat.id];
      if (!estadoActual) return;

      let invalida = false;

      // requisito por porcentaje
      if (mat.requierePorcentaje) {
        if (porcentajeAprobadas(mat.id) < mat.requierePorcentaje) {
          invalida = true;
        }
      }

      // requisito por cantidad aprobadas
      if (!invalida && mat.requiereAprobadas) {
        const aprobadas = Object.values(estados)
          .filter(e => e === "promocion" || e === "regular").length;
        if (aprobadas < mat.requiereAprobadas) {
          invalida = true;
        }
      }

      // requisito por correlativas
      if (
        !invalida &&
        Array.isArray(mat.requisitos) &&
        mat.requisitos.length
      ) {
        const faltan = mat.requisitos.some(r => {
          const est = estados[r];
          return !(est === "promocion" || est === "regular");
        });
        if (faltan) invalida = true;
      }

      // üî• si qued√≥ inv√°lida ‚Üí borrar estado
      if (invalida) {
        delete estados[mat.id];
        changed = true;
      }
    });
  }

  setEstados(estados);
}

  function updateUI(){
    const estados = getEstados();
    document.querySelectorAll(".subject").forEach(el=>{
      const id = el.dataset.id;
      el.className = "subject";
      const mat = materias.find(x=>x.id===id);
      const estado = estados[id];
      let bloqueada = false;

      if(mat && mat.requierePorcentaje){
        if(porcentajeAprobadas(mat.id) < mat.requierePorcentaje) bloqueada = true;
      }else if(mat && mat.requiereAprobadas){
        const aprobadas = Object.values(estados).filter(e => e === "promocion" || e === "regular").length;
        if(aprobadas < mat.requiereAprobadas) bloqueada = true;
      }else if(mat && Array.isArray(mat.requisitos) && mat.requisitos.length){
        const faltan = mat.requisitos.filter(r=>{
          const est = estados[r];
          return !(est === "promocion" || est === "regular");
        });
        if(faltan.length) bloqueada = true;
      }

      if(bloqueada && !estado) el.classList.add("locked");
      if(estado) el.classList.add(estado);
    });

    updateStatsUI();
  }

  function openMenuFor(element, clientX, clientY){
    const id = element.dataset.id;
    menu.style.display = "block";
    menu.innerHTML = `
      <div class="plan-menu-card">
        <div data-estado="promocion" class="btn plan-menu-item">Promoci√≥n</div>
        <div data-estado="regular" class="btn plan-menu-item">Regular</div>
        <div data-estado="libre" class="btn plan-menu-item">Libre</div>
        <div data-estado="curso" class="btn plan-menu-item">En curso</div>
        <div data-estado="ninguno" class="btn plan-menu-item plan-menu-item-last">Quitar estado</div>
      </div>
    `;

    const pad = 10, mw = 240;
    let left = clientX, top = clientY;
    if(left + mw > window.innerWidth - pad) left = window.innerWidth - mw - pad;
    if(top + 240 > window.innerHeight - pad) top = window.innerHeight - 240 - pad;
    menu.style.left = left + "px";
    menu.style.top = top + "px";
    menu.style.position = "fixed";

    menu.querySelectorAll("[data-estado]").forEach(item=>{
      item.addEventListener("click", ()=>{
        const estado = item.dataset.estado;
        const estados = getEstados();
        if(estado === "ninguno") delete estados[id];
        else estados[id] = estado;
        setEstados(estados);
        revalidateEstados();
        closeMenu();
        updateUI();
      });
    });

    setTimeout(()=> window.addEventListener("click", outClick), 0);
    window.addEventListener("keydown", onEsc);

    function outClick(ev){
      if(!menu.contains(ev.target) && ev.target !== element) closeMenu();
    }
    function onEsc(e){
      if(e.key === "Escape") closeMenu();
    }
    function closeMenu(){
      menu.style.display = "none";
      menu.innerHTML = "";
      window.removeEventListener("click", outClick);
      window.removeEventListener("keydown", onEsc);
    }
  }

  function attachEventsToSubjects(){
    document.querySelectorAll(".subject").forEach(el=>{
      el.onclick = (e)=>{
        const estados = getEstados();
        if(el.classList.contains("locked") && !estados[el.dataset.id]) return;
        openMenuFor(el, e.clientX + 4, e.clientY + 4);
      };
    });
  }

  function detectMaterias(data){
    if(Array.isArray(data)) return data;
    if(data && Array.isArray(data.materias)) return data.materias;
    if(data && Array.isArray(data.subjects)) return data.subjects;
    return [];
  }

  const aliasMap = new Map();

  function registerAlias(alias, realSlug){
    const normalizedAlias = normalize(alias);
    const normalizedReal = normalize(realSlug);
    if (!normalizedAlias || !normalizedReal || aliasMap.has(normalizedAlias)) return;
    aliasMap.set(normalizedAlias, realSlug);
  }

  function buildAliasMap(plans){
    aliasMap.clear();
    (plans || []).forEach((plan) => {
      const realSlug = (plan.slug || "").trim();
      if (!realSlug) return;

      const resolvedSlug = resolvePlanSlug(realSlug);
      const nameSlug = slugify(plan.nombre || "");

      registerAlias(realSlug, realSlug);
      registerAlias(resolvedSlug, realSlug);
      registerAlias(nameSlug, realSlug);

      if (nameSlug){
        registerAlias(`ingenieria-${nameSlug}`, realSlug);
        registerAlias(`ingenieria-en-${nameSlug}`, realSlug);
      }

      if (resolvedSlug){
        registerAlias(`ingenieria-${resolvedSlug}`, realSlug);
        registerAlias(`ingenieria-en-${resolvedSlug}`, realSlug);
      }
    });
  }

  function findPlanInIndex(slugInput){
    const normalizedInput = normalize(slugInput);
    return indexPlans.find((plan) => normalize(plan.slug) === normalizedInput) || null;
  }

  function resolvePlanDocId(slugInput){
    const attempts = [];
    const addAttempt = (value) => {
      const normalizedValue = normalize(value);
      if (!normalizedValue) return;
      if (!attempts.includes(normalizedValue)) attempts.push(normalizedValue);
    };

    const rawSlug = String(slugInput || "");
    const resolvedSlug = resolvePlanSlug(rawSlug);

    addAttempt(rawSlug);
    addAttempt(resolvedSlug);

    if (resolvedSlug){
      addAttempt(`ingenieria-${resolvedSlug}`);
      addAttempt(`ingenieria-en-${resolvedSlug}`);
    }

    let resolvedDocId = "";
    for (const attempt of attempts){
      const fromAlias = aliasMap.get(attempt);
      if (fromAlias){
        resolvedDocId = fromAlias;
        break;
      }

      const fromIndex = findPlanInIndex(attempt);
      if (fromIndex?.slug){
        resolvedDocId = fromIndex.slug;
        break;
      }
    }

    return { resolvedDocId, attempts };
  }

  async function loadPlans(){
    const snapshot = await getDocs(collection(db, "plans"));
    return snapshot.docs.map((snap) => ({
      id: snap.id,
      ...snap.data()
    }));
  }

  async function loadPlan(slug){
    const snap = await getDoc(doc(db, "plans", slug));
    if (!snap.exists()) {
      throw new Error("Plan no encontrado");
    }
    return { id: snap.id, ...snap.data() };
  }

  async function loadIndex(){
    const plans = await loadPlans();
    indexPlans = (Array.isArray(plans) ? plans : []).map((plan) => ({
      slug: plan.slug || plan.id || "",
      nombre: plan.nombre || plan.slug || plan.id || "Sin nombre",
      version: Number(plan.version || 1)
    })).filter((plan) => !!plan.slug).sort((a,b)=>{
      return normalize(a.nombre).localeCompare(normalize(b.nombre), "es");
    });

    buildAliasMap(indexPlans);

    planSelect.innerHTML = `<option value="">Eleg√≠ plan‚Ä¶</option>`;
    indexPlans.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p.slug || "";
      opt.textContent = p.nombre || p.slug || "Sin nombre";
      planSelect.appendChild(opt);
    });
  }

  async function loadPlanBySlug(slugInput){
    const rawSlug = String(slugInput || "");
    const resolvedSlug = resolvePlanSlug(rawSlug);
    const { resolvedDocId, attempts } = resolvePlanDocId(rawSlug);

    console.log("[plans] slug recibido:", rawSlug);
    console.log("[plans] slug resuelto:", resolvedSlug);

    if(!resolvedDocId){
      gridWrap.style.display = "none";
      title.textContent = "Planes de Estudio";
      const examples = indexPlans.slice(0, 3).map((plan) => plan.slug).filter(Boolean).join(", ") || "(sin planes disponibles)";
      showMsg(`No se encontr√≥ el plan para slug: ${rawSlug}. Prob√©: [${attempts.join(", ")}]. Planes disponibles: ${examples}`);
      return;
    }

    hideMsg();

    const plan = findPlanInIndex(resolvedDocId);
    const planData = await loadPlan(resolvedDocId);
    const planSlug = planData.slug || planData.id || plan?.slug || resolvedDocId;
    storageKey = `${STORAGE_KEY_DEFAULT}_${planSlug}`;

    materias = detectMaterias(planData);
    console.log("[plans] docId final usado:", resolvedDocId);
    console.log("[plans] cantidad de materias detectadas:", Array.isArray(materias) ? materias.length : 0);

    if(!Array.isArray(materias) || !materias.length){
      gridWrap.style.display = "none";
      showMsg(`El plan ${resolvedDocId} no tiene materias v√°lidas para mostrar.`);
      return;
    }

    title.textContent = planData.nombre || plan?.nombre || "Plan de Estudios";
    gridWrap.style.display = "grid";

    buildGrid();
    placeSubjects();
    attachEventsToSubjects();
    updateUI();

    sessionStorage.setItem("selectedPlanSlug", planSlug || "");
    sessionStorage.setItem("selectedPlanNombre", planData.nombre || plan?.nombre || "");
    planSelect.value = planSlug || resolvedDocId || "";
  }


  btnBack.addEventListener("click", ()=> window.location.href = getBackUrl());

  btnReset.addEventListener("click", async ()=>{
    const ok = await showConfirm({
      title:"Reiniciar estados",
      message:"¬øQuer√©s reiniciar todos los estados? Esta acci√≥n no se puede deshacer.",
      confirmText:"Reiniciar",
      cancelText:"Cancelar",
      danger:true
    });
    if(!ok) return;
    localStorage.removeItem(storageKey);
    updateUI();
  });

  planSelect.addEventListener("change", ()=>{
    const slug = planSelect.value;
    if(!slug){
      gridWrap.style.display = "none";
      title.textContent = "Planes de Estudio";
      showMsg("Eleg√≠ una carrera para abrir su plan.");
      storageKey = STORAGE_KEY_DEFAULT;
      return;
    }
    loadPlanBySlug(slug).catch(e=>{
      gridWrap.style.display = "none";
      showMsg("Error al cargar el plan: " + (e && e.message ? e.message : e));
    });
  });

  window.addEventListener("storage", (e)=>{ if(e.key === storageKey) updateUI(); });

  async function initPlansPage(){
    try{
      await loadIndex();

      // 1) query string directo (modo embebido o link directo)
      if (slugParam){
        await loadPlanBySlug(slugParam);
        return;
      }

      // 2) si ven√≠s desde plans_index.html o app.html sin query string, uso sessionStorage
      const saved = sessionStorage.getItem("selectedPlanSlug") || "";
      if(saved){
        await loadPlanBySlug(saved);
        return;
      }

      // 3) si no hay nada seleccionado, muestro mensaje
      gridWrap.style.display = "none";
      title.textContent = "Planes de Estudio";
      showMsg("Eleg√≠ una carrera para abrir su plan.");
    }catch(e){
      gridWrap.style.display = "none";
      showMsg("Error al cargar el √≠ndice desde Firestore: " + (e && e.message ? e.message : e));
    }
  }

  document.addEventListener("DOMContentLoaded", async () => {
    await initPlansPage();
  });
})();
</script>
</body>
</html>
