rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function isOwner(uid) { return signedIn() && request.auth.uid == uid; }
    function isAdmin() {
      return signedIn() && (
        request.auth.token.admin == true ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
      );
    }

    function validSubjectIds(listValue) {
      return listValue is list && listValue.size() <= 500;
    }

    function validUserAcademicState(data) {
      return data.careerSlug is string
        && data.careerSlug.size() > 0
        && (!('planVersion' in data) || data.planVersion is int)
        && (!('approvedSubjects' in data) || validSubjectIds(data.approvedSubjects))
        && (!('currentSubjects' in data) || validSubjectIds(data.currentSubjects));
    }

    function validPublicUserData(data) {
      return data.uid is string
        && data.email is string
        && data.emailLower is string
        && data.name is string
        && data.photoURL is string
        && (!('careerSlug' in data) || data.careerSlug is string);
    }

    // ---- users (privado) ----
    match /users/{uid} {
      allow read: if isOwner(uid) || isAdmin();
      allow create: if (isOwner(uid) || isAdmin()) && validUserAcademicState(request.resource.data);
      allow update: if (isOwner(uid) || isAdmin()) && validUserAcademicState(request.resource.data);
      allow delete: if isAdmin();
    }

    // ---- plans (estructura académica global) ----
    match /plans/{careerSlug} {
      allow read: if signedIn();
      allow create, update, delete: if isAdmin();
    }

    // ---- comisiones (oferta académica) ----
    match /comisiones/{id} {
      allow read: if signedIn() && (resource.data.careerSlugs is list);
      allow create, update, delete: if isAdmin()
        && (request.resource.data.careerSlugs is list)
        && request.resource.data.careerSlugs.size() > 0;
    }

    // ---- publicUsers (directorio) ----
    match /publicUsers/{uid} {
      allow read: if signedIn();
      allow create: if (isOwner(uid) || isAdmin())
        && validPublicUserData(request.resource.data)
        && request.resource.data.uid == uid;
      allow update: if (isOwner(uid) || isAdmin())
        && validPublicUserData(request.resource.data)
        && request.resource.data.uid == resource.data.uid
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          "email",
          "emailLower",
          "name",
          "photoURL",
          "careerSlug",
          "updatedAt"
        ]);
      allow delete: if isOwner(uid) || isAdmin();
    }

    // ---- planner ----
    match /planner/{uid} {
      allow read, create, update: if isOwner(uid) || isAdmin();
      allow delete: if isAdmin();
    }

    // ---- courseSections (admin) ----
    match /courseSections/{id} {
      allow read: if signedIn();
      allow create, update, delete: if isAdmin();
    }

    // ---- professors (lectura pública autenticada) ----
    match /professors/{professorId} {
      allow read: if signedIn();
      // Seguridad: los agregados se actualizan solo desde Cloud Functions.
      allow create, update, delete: if isAdmin();

      match /reviews/{uid} {
        allow read: if signedIn();
        // Solo Cloud Functions (Admin SDK) puede escribir reviews.
        allow create, update, delete: if false;
      }
    }

    // ---- professorReviews (lectura autenticada) ----
    match /professorReviews/{reviewId} {
      allow read: if signedIn();
      allow write: if false;
    }

    // ---- status / presencia ----
    match /userStatus/{uid} {
      allow read: if signedIn();
      allow create, update: if isOwner(uid);
      allow delete: if false;
    }

    // ---- solicitudes ----
    match /friendRequests/{id} {
      function reqFrom(data) {
        return data.fromUid is string ? data.fromUid :
               data.senderUid is string ? data.senderUid :
               data.senderId is string ? data.senderId : "";
      }
      function reqTo(data) {
        return data.toUid is string ? data.toUid :
               data.receiverUid is string ? data.receiverUid :
               data.recipientUid is string ? data.recipientUid : "";
      }

      allow read: if signedIn() && (
        request.auth.uid == reqFrom(resource.data) ||
        request.auth.uid == reqTo(resource.data) ||
        isAdmin()
      );

      allow create: if signedIn()
        && reqFrom(request.resource.data) == request.auth.uid
        && reqTo(request.resource.data) is string
        && request.resource.data.status == "pending";

      allow update: if signedIn() && (
        // receiver acepta/rechaza
        (
          request.auth.uid == reqTo(resource.data) &&
          request.resource.data.diff(resource.data).changedKeys()
            .hasOnly(["status","updatedAt","decisionBy"]) &&
          (request.resource.data.status in ["accepted","rejected"])
        )
        ||
        // sender cancela
        (
          request.auth.uid == reqFrom(resource.data) &&
          request.resource.data.diff(resource.data).changedKeys()
            .hasOnly(["status","updatedAt","canceledBy"]) &&
          request.resource.data.status == "canceled"
        )
      );

      allow delete: if false;
    }

    // ---- friends (legacy/compat) ----
    match /friends/{chatId} {
      allow read: if signedIn() && (request.auth.uid in resource.data.uids);
      allow create: if signedIn() && (request.auth.uid in request.resource.data.uids);
      allow update: if signedIn()
        && (request.auth.uid in resource.data.uids)
        && request.resource.data.uids == resource.data.uids
        && request.resource.data.chatId == resource.data.chatId
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(["createdAt","uids","chatId"]);
      allow delete: if false;
    }

    // ---- chats + messages ----
    match /chats/{chatId} {

      function isParticipant(data) {
        return signedIn()
          && ((data.users is list && request.auth.uid in data.users)
            || (data.uids is list && request.auth.uid in data.uids));
      }

      allow read: if isParticipant(resource.data);

      allow create: if signedIn()
        && ((request.resource.data.users is list && request.auth.uid in request.resource.data.users)
          || (request.resource.data.uids is list && request.auth.uid in request.resource.data.uids));

      // no permitir cambiar miembros ni createdAt una vez creado
      allow update: if isParticipant(resource.data)
        && request.resource.data.diff(resource.data).changedKeys()
          .hasOnly(['lastMessage','updatedAt','users','uids'])
        && request.resource.data.users == resource.data.users
        && request.resource.data.uids == resource.data.uids;

      allow delete: if false;

      match /messages/{messageId} {
        function senderMatches() {
          return signedIn()
            && ((request.resource.data.senderUid is string && request.resource.data.senderUid == request.auth.uid)
              || (request.resource.data.senderId is string && request.resource.data.senderId == request.auth.uid));
        }

        allow read: if isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data);

        allow create: if senderMatches()
          && isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data);

        allow update, delete: if false;
      }
    }
  }
}
