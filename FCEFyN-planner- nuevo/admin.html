<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Panel de administración — FCEFyN Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/global.css">
  <link rel="stylesheet" href="styles/admin.css">
  <script src="scripts/theme-toggle.js" defer></script>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <div class="sidebar-title">FCEFyN Planner</div>
    <div class="sidebar-sub">
      Panel Admin — gestión de usuarios y carga de horarios para que los estudiantes armen su agenda.
    </div>

    <div class="nav-section">Secciones</div>

    <div class="nav-item active" id="navUsers" data-section="users">
      <span>Usuarios</span>
      <span class="nav-badge" id="badgeUsers">0</span>
    </div>

    <div class="nav-item" id="navSections" data-section="sections">
      <span>Horarios de materias</span>
      <span class="nav-badge" id="badgeSections">0</span>
    </div>

    <div class="nav-item" id="navProfessors" data-section="professors">
      <span>Profesores</span>
      <span class="nav-badge" id="badgeProfessors">0</span>
    </div>
  </aside>

  <div class="main">
    <header class="topbar">
      <div class="topbar-title" id="topbarTitle">Panel de administración — Usuarios</div>
      <div class="topbar-right">
        <button class="theme-toggle" data-theme-toggle type="button">
          <span class="ico">☀️</span><span class="label">Modo claro</span>
        </button>
        <div id="adminEmail" class="topbar-email">—</div>
        <button class="btn btn-outline" id="btnLogout">Cerrar sesión</button>
      </div>
    </header>

    <div class="content">
      <div class="cards-row">
        <div class="card">
          <div class="card-title">Usuarios</div>
          <div class="metric-main" id="metricUsersTotal">0</div>
          <div class="metric-sub" id="metricUsersDetail">Admin: 0 · Estudiantes: 0 · Suspendidos: 0</div>
        </div>

        <div class="card">
          <div class="card-title">Horarios cargados</div>
          <div class="metric-main" id="metricSectionsTotal">0</div>
          <div class="metric-sub" id="metricSectionsDetail">Materias distintas: 0</div>
        </div>

        <div class="card">
          <div class="card-title">Profesores</div>
          <div class="metric-main" id="metricProfessorsTotal">0</div>
          <div class="metric-sub" id="metricProfessorsDetail">Activos: 0 · Ocultos: 0</div>
        </div>
      </div>

      <div id="section-users" class="section-wrap active">
        <div class="card">
          <div class="card-header">
            <h2>Usuarios</h2>
            <div class="muted">Rol, suspensión por minutos y quitar suspensión</div>
          </div>
          <div id="usersCards" class="users-grid"></div>
        </div>
      </div>

      <div id="section-sections" class="section-wrap">
        <div class="card">
          <div class="card-header">
            <h2>Horarios de materias / comisiones</h2>
            <button class="btn btn-blue" id="btnNewSection">+ Nuevo horario</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Materia</th>
                  <th>Comisión</th>
                  <th>Día</th>
                  <th>Horario</th>
                  <th>Sede</th>
                  <th>Aula</th>
                  <th>Docentes</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="sectionsTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="section-professors" class="section-wrap">
        <div class="card">
          <div class="card-header">
            <h2>Profesores</h2>
            <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">
              <span class="muted">Carga, carreras, materias y visibilidad.</span>
              <button class="btn btn-blue" id="btnNewProfessor">+ Nuevo profesor</button>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Carreras</th>
                  <th>Materias</th>
                  <th>Estado</th>
                  <th>Promedio</th>
                  <th>Evaluaciones</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="professorsTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="modal-bg" id="sectionModalBg">
  <div class="modal">
    <h3 id="sectionModalTitle">Nuevo horario</h3>

    <div class="modal-grid">
      <div>
        <label>Materia</label>
        <select id="secSubject" disabled>
          <option value="">Elegí materia…</option>
        </select>
      </div>
      <div>
        <label>Comisión</label>
        <input id="secCommission" placeholder="Ej: 2.2">
      </div>
      <div>
        <label>Carrera (opcional)</label>
        <select id="secDegree">
          <option value="">Elegí carrera…</option>
        </select>
      </div>
      <div>
        <label>Aula</label>
        <input id="secRoom" placeholder="Ej: 109">
      </div>
      <div>
        <label>Sede (por defecto)</label>
        <select id="secCampus">
          <option value="">—</option>
          <option value="Ciudad Universitaria">Ciudad Universitaria</option>
          <option value="Centro">Centro</option>
          <option value="Virtual sincrónica">Virtual sincrónica</option>
        </select>
      </div>
      <div>
        <label>Correo jefe de ctedra</label>
        <input id="secHeadEmail" type="email" placeholder="correo@fcefyn.unc.edu.ar">
      </div>
    </div>

    <div class="modal-grid">
      <div>
        <label>Titular</label>
        <input id="secTitular" placeholder="Nombre del titular">
      </div>
      <div>
        <label>Agregar docente / asistente / adjunto</label>
        <div style="display:flex; gap:.4rem;">
          <input id="docenteName" placeholder="Nombre">
          <select id="docenteRole" style="max-width:150px;">
            <option value="Docente">Docente</option>
            <option value="Asistente">Asistente</option>
            <option value="Adjunto">Adjunto</option>
            <option value="Otro">Otro</option>
          </select>
          <button class="btn btn-gray" type="button" id="btnAddDocente">Añadir</button>
        </div>
      </div>
    </div>

    <div style="margin-bottom:.4rem;">
      <div id="docentesChips"></div>
    </div>

    <hr style="border:none;border-top:1px solid var(--border);margin:.7rem 0;">

    <div>
      <label>Días, horarios y sede</label>
      <div style="display:flex; gap:.4rem; flex-wrap:wrap; margin-bottom:.4rem;">
        <select id="daySelect" style="min-width:120px;">
          <option value="">Día</option>
          <option value="Lunes">Lunes</option>
          <option value="Martes">Martes</option>
          <option value="Miércoles">Miércoles</option>
          <option value="Jueves">Jueves</option>
          <option value="Viernes">Viernes</option>
          <option value="Sábado">Sábado</option>
        </select>
        <input id="dayStart" type="time">
        <input id="dayEnd" type="time">
        <select id="dayCampus" style="min-width:170px;">
          <option value="">Sede del día</option>
          <option value="Ciudad Universitaria">Ciudad Universitaria</option>
          <option value="Centro">Centro</option>
          <option value="Virtual sincrónica">Virtual sincrónica</option>
        </select>
        <button class="btn btn-gray" type="button" id="btnAddDay">Agregar día</button>
      </div>
      <div id="daysChips"></div>
      <div class="muted" style="margin-top:.2rem;">
        Podés cargar hasta <strong>2 días por comisión</strong> (por ejemplo Lunes 11:30–14:45 en Ciudad Universitaria
        y Miércoles 15:00–18:15 en Centro).
      </div>
    </div>

    <div class="muted" style="margin-top:.7rem;">
      Este horario se guarda en <code>/courseSections</code> y luego lo vamos a usar para que los estudiantes armen su agenda semanal.
    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" type="button" id="btnDeleteSection" style="display:none;">Borrar horario</button>
      <div class="modal-footer-right">
        <button class="btn btn-gray" type="button" id="btnCancelSection">Cancelar</button>
        <button class="btn btn-blue" type="button" id="btnSaveSection">Guardar</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-bg" id="profModalBg">
  <div class="modal modal-wide">
    <h3 id="profModalTitle">Nuevo profesor</h3>
    <div class="modal-grid">
      <div>
        <label>Nombre del profesor</label>
        <input id="profName" placeholder="Ej: Ing. Juan Pérez">
      </div>
      <div>
        <label>Visibilidad</label>
        <div style="display:flex;align-items:center;gap:.5rem;margin-top:.35rem;">
          <input id="profActive" type="checkbox">
          <span class="muted">Activo / visible para estudiantes</span>
        </div>
      </div>
    </div>

    <div class="modal-grid">
      <div>
        <label>Agregar carrera</label>
        <div style="display:flex;gap:.4rem;flex-wrap:wrap;align-items:center;">
          <select id="profCareerSelect" style="min-width:220px;">
            <option value="">Elegí carrera…</option>
          </select>
          <button class="btn btn-gray" type="button" id="btnAddCareer">Añadir</button>
        </div>
        <div class="muted" style="margin-top:.25rem;">Opciones tomadas de los JSON de planes. Podés cargar varias.</div>
      </div>
      <div>
        <label>Agregar materia</label>
        <div style="display:flex;gap:.4rem;flex-wrap:wrap;align-items:center;">
          <select id="profSubjectCareerSelect" style="min-width:160px;">
            <option value="">Elegí carrera…</option>
          </select>
          <select id="profSubjectSelect" style="min-width:220px;">
            <option value="">Elegí materia…</option>
          </select>
          <button class="btn btn-gray" type="button" id="btnAddSubject">Añadir</button>
        </div>
        <div class="muted" style="margin-top:.25rem;">Las materias dependen de la carrera seleccionada.</div>
      </div>
    </div>

    <div style="margin-top:.6rem;">
      <label>Carreras cargadas</label>
      <div id="profCareersChips" style="margin-top:.3rem;"></div>
    </div>
    <div style="margin-top:.6rem;">
      <label>Materias cargadas</label>
      <div id="profSubjectsChips" style="margin-top:.3rem;"></div>
    </div>

    <div class="muted" style="margin-top:.8rem;">
      Se guarda en <code>/professors</code>. Las reseñas se almacenan en <code>/professorReviews</code> y calculan los promedios por criterio.
    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" type="button" id="btnCancelProfessor">Cancelar</button>
      <div class="modal-footer-right">
        <button class="btn btn-danger" type="button" id="btnDeleteProfessor" style="display:none;">Eliminar</button>
        <button class="btn btn-blue" type="button" id="btnSaveProfessor">Guardar</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import {
  getFirestore, collection, doc, getDoc, getDocs,
  addDoc, updateDoc, deleteDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { showToast, showConfirm, showPrompt } from "./ui/notifications.js";
import { getPlansIndex, getPlanWithSubjects, mapCareersToPlans, normalizeStr } from "./scripts/plans-data.js";

const firebaseConfig = {
  apiKey: "AIzaSyA0i7hkXi5C-x3UwAEsh6FzRFqrFE5jpd8",
  authDomain: "fcefyn-planner.firebaseapp.com",
  projectId: "fcefyn-planner",
  storageBucket: "fcefyn-planner.firebasestorage.app",
  messagingSenderId: "713668406730",
  appId: "1:713668406730:web:f41c459641bfdce0cd7333",
  measurementId: "G-HLBVB8QHM8"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

let currentUser = null;

/* ---------- estado modal horarios ---------- */
let editingSectionId = null;
let daysList = [];      // {day, start, end, campus}
let docentesList = [];  // {name, role}

/* ---------- NUEVO: estado modal profesores ---------- */
let editingProfessorId = null;
let professorCareers = [];
let professorSubjects = [];
let plansIndex = [];
const planSubjectsCache = new Map(); // slug -> array materias

/* ---------- helpers UI ---------- */
const qs  = sel => document.querySelector(sel);

/* ---------- planes (JSON local) ---------- */
async function ensurePlansIndex(){
  if (plansIndex.length) return;
  try{
    plansIndex = await getPlansIndex();
  }catch(e){
    plansIndex = [];
    showToast({ message:"No pude leer plans_index.json: " + (e.message || e), type:"error" });
  }
}

async function getSubjectsForCareer(slug){
  if (!slug) return [];
  if (planSubjectsCache.has(slug)) return planSubjectsCache.get(slug);
  try{
    const { subjects } = await getPlanWithSubjects(slug);
    const sorted = subjects.slice().sort((a,b)=> normalizeStr(a.nombre||a.id).localeCompare(normalizeStr(b.nombre||b.id), "es"));
    planSubjectsCache.set(slug, sorted);
    return sorted;
  }catch(e){
    showToast({ message:"No pude leer materias de " + slug + ": " + (e.message || e), type:"error" });
    return [];
  }
}

function planNameFromSlug(slug){
  const plan = plansIndex.find(p => p.slug === slug);
  return plan ? plan.nombre : slug;
}

// === NUEVAS FUNCIONES PARA MODAL HORARIOS (PATCH) ===
async function setSectionCareerOptions(selectedSlug="", selectedName=""){
  const sel = qs("#secDegree");
  if (!sel) return;
  await ensurePlansIndex();
  sel.innerHTML = `<option value=\"\">Elegí carrera…</option>`;
  plansIndex.forEach(p =>{
    const opt = document.createElement("option");
    opt.value = p.slug;
    opt.textContent = p.nombre || p.slug;
    opt.dataset.name = p.nombre || p.slug;
    sel.appendChild(opt);
  });

  if (selectedSlug && plansIndex.some(p => p.slug === selectedSlug)){
    sel.value = selectedSlug;
    return;
  }
  if (selectedName){
    const match = plansIndex.find(p => normalizeStr(p.nombre||p.slug) === normalizeStr(selectedName));
    if (match){
      sel.value = match.slug;
      return;
    }
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = selectedName;
    opt.dataset.name = selectedName;
    opt.selected = true;
    opt.dataset.custom = "true";
    sel.appendChild(opt);
  }
}

async function updateSectionSubjectOptions(selectedSubjectId="", degreeSlugOverride="", selectedSubjectName=""){
  const sel = qs("#secSubject");
  const selDegree = qs("#secDegree");
  if (!sel || !selDegree) return;
  const slug = degreeSlugOverride || selDegree.value;
  const targetName = selectedSubjectName || selectedSubjectId;
  sel.innerHTML = `<option value=\"\">Elegí materia…</option>`;

  if (!slug){
    sel.disabled = true;
    if (targetName){
      const opt = document.createElement("option");
      opt.value = selectedSubjectId || targetName;
      opt.textContent = targetName;
      opt.dataset.subjectName = targetName;
      opt.selected = true;
      sel.appendChild(opt);
    }
    return;
  }

  sel.disabled = false;
  const subjects = await getSubjectsForCareer(slug);
  let matched = false;
  subjects.forEach(sub =>{
    const id = sub.id || sub.nombre;
    if (!id) return;
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = sub.nombre || sub.id || "Materia";
    opt.dataset.subjectName = sub.nombre || sub.id || "Materia";
    opt.disabled = false;
    if (
      (selectedSubjectId && (selectedSubjectId === id || normalizeStr(selectedSubjectId) === normalizeStr(id))) ||
      (targetName && normalizeStr(targetName) === normalizeStr(sub.nombre||sub.id))
    ){
      opt.selected = true;
      matched = true;
    }
    sel.appendChild(opt);
  });

  if (targetName && !matched){
    const opt = document.createElement("option");
    opt.value = selectedSubjectId || targetName;
    opt.textContent = targetName;
    opt.dataset.subjectName = targetName;
    opt.selected = true;
    sel.appendChild(opt);
  }
}
// ====================================================

function setSubjectSelectorsAvailability(){
  const selCareer = qs("#profSubjectCareerSelect");
  const selSubject = qs("#profSubjectSelect");
  const hasCareers = professorCareers.length > 0;

  if (selCareer){
    selCareer.disabled = !hasCareers;
    if (!hasCareers) selCareer.value = "";
  }
  if (selSubject){
    selSubject.disabled = !hasCareers;
    if (!hasCareers){
      selSubject.innerHTML = `<option value=\"\">Elegí materia…</option>`;
      selSubject.value = "";
    }
  }
}

/* ---------- navegación secciones ---------- */
function setActiveNav(section){
  const navUsers = qs("#navUsers");
  const navSecs  = qs("#navSections");
  const navProf  = qs("#navProfessors"); // NUEVO
  const secUsers = qs("#section-users");
  const secSecs  = qs("#section-sections");
  const secProf  = qs("#section-professors"); // NUEVO
  const topTitle = qs("#topbarTitle");

  navUsers.classList.toggle("active", section === "users");
  navSecs.classList.toggle("active", section === "sections");
  navProf.classList.toggle("active", section === "professors");

  secUsers.classList.toggle("active", section === "users");
  secSecs.classList.toggle("active", section === "sections");
  secProf.classList.toggle("active", section === "professors");

  if(section === "users") topTitle.textContent = "Panel de administración — Usuarios";
  else if(section === "sections") topTitle.textContent = "Panel de administración — Horarios de materias";
  else topTitle.textContent = "Panel de administración — Profesores";
}

function wireSidebar(){
  qs("#navUsers").addEventListener("click", ()=> setActiveNav("users"));
  qs("#navSections").addEventListener("click", ()=> setActiveNav("sections"));
  qs("#navProfessors").addEventListener("click", ()=> setActiveNav("professors")); // NUEVO
}

/* ---------- sesión / acceso ---------- */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "app.html";
    return;
  }

  const userRef = doc(db,"users",user.uid);
  const snap = await getDoc(userRef);
  if (!snap.exists() || snap.data().role !== "admin") {
    window.location.href = "student.html";
    return;
  }

  currentUser = user;
  qs("#adminEmail").textContent = user.email || "—";

  attachGlobalHandlers();
  wireSidebar();
  setActiveNav("users");

  // Cargamos también loadProfessors()
  await Promise.all([loadUsers(), loadSections(), loadProfessors()]);
});

function attachGlobalHandlers(){
  qs("#btnLogout").addEventListener("click", async () => {
    try{
      await signOut(auth);
      window.location.href = "app.html";
    }catch(e){
      showToast({ message: "Error al cerrar sesión: " + (e.message || e), type:"error" });
    }
  });

  // Botones Sección Horarios
  qs("#btnNewSection").addEventListener("click", () => openSectionModal(null).catch(console.error));
  qs("#btnCancelSection").addEventListener("click", closeSectionModal);
  qs("#sectionModalBg").addEventListener("click", (e)=>{
    if (e.target === qs("#sectionModalBg")) closeSectionModal();
  });
  // Evento para actualizar materias al cambiar carrera en horarios
  qs("#secDegree").addEventListener("change", ()=> updateSectionSubjectOptions().catch(console.error));

  qs("#btnAddDay").addEventListener("click", addDayToList);
  qs("#btnAddDocente").addEventListener("click", addDocenteToList);
  qs("#btnSaveSection").addEventListener("click", saveSection);
  qs("#btnDeleteSection").addEventListener("click", deleteCurrentSection);

  // NUEVO: Botones Sección Profesores
  qs("#btnNewProfessor").addEventListener("click", ()=> openProfessorModal(null).catch(console.error));
  qs("#btnCancelProfessor").addEventListener("click", closeProfessorModal);
  qs("#profModalBg").addEventListener("click", (e)=>{ if (e.target === qs("#profModalBg")) closeProfessorModal(); });
  qs("#btnAddCareer").addEventListener("click", ()=> addCareerToList().catch(console.error));
  qs("#btnAddSubject").addEventListener("click", ()=> addSubjectToList().catch(console.error));
  qs("#profSubjectCareerSelect").addEventListener("change", ()=> updateSubjectSelectOptions().catch(console.error));
  qs("#btnSaveProfessor").addEventListener("click", saveProfessor);
  qs("#btnDeleteProfessor").addEventListener("click", deleteProfessor);

  // acciones de tabla de horarios
  qs("#sectionsTableBody").addEventListener("click", async (e)=>{
    const id = e.target.getAttribute("data-id");
    if (!id) return;
    if (e.target.classList.contains("btn-edit-section")){
      const ref = doc(db,"courseSections",id);
      const snap = await getDoc(ref);
      if (!snap.exists()) return;
      await openSectionModal(id,snap.data());
    } else if (e.target.classList.contains("btn-delete-section")){
      const ok = await showConfirm({
        title:"Borrar horario",
        message:"Se eliminará la comisión y todos sus días asociados.",
        confirmText:"Borrar",
        cancelText:"Cancelar",
        danger:true
      });
      if (!ok) return;
      await deleteDoc(doc(db,"courseSections",id));
      await loadSections();
      showToast({ message:"Horario eliminado.", type:"success" });
    }
  });

  // NUEVO: acciones de tabla de profesores
  qs("#professorsTableBody").addEventListener("click", async (e)=>{
    const id = e.target.getAttribute("data-id");
    if (!id) return;

    if (e.target.classList.contains("btn-edit-prof")){
      const ref = doc(db,"professors",id);
      const snap = await getDoc(ref);
      if (!snap.exists()) return;
      await openProfessorModal(id, snap.data());
    } else if (e.target.classList.contains("btn-toggle-prof")){
      const ref = doc(db,"professors",id);
      const snap = await getDoc(ref);
      if (!snap.exists()) return;
      const active = !!snap.data().active;
      await updateDoc(ref, { active: !active, updatedAt: serverTimestamp() });
      await loadProfessors();
      showToast({ message: !active ? "Profesor publicado para estudiantes." : "Profesor ocultado.", type: !active ? "success" : "warning" });
    }
  });
}

/* ---------- helpers suspensión ---------- */
function nowMs(){ return Date.now(); }
function getSuspendedUntilMs(data){
  const v = data.suspendedUntil;
  if (!v) return 0;
  if (typeof v === "number") return v;
  if (v && typeof v.toMillis === "function") return v.toMillis();
  return 0;
}
function isSuspended(data){
  const until = getSuspendedUntilMs(data);
  return until > nowMs();
}
function fmtUntil(untilMs){
  try{
    const d = new Date(untilMs);
    return d.toLocaleString("es-AR");
  }catch(_){
    return "";
  }
}
function minutesLeft(untilMs){
  const diff = untilMs - nowMs();
  if (diff <= 0) return 0;
  return Math.ceil(diff / 60000);
}

/* ---------- usuarios (CARDS) ---------- */
async function loadUsers(){
  const usersSnap = await getDocs(collection(db,"users"));
  const cont = qs("#usersCards");
  cont.innerHTML = "";

  let total = 0, admins = 0, students = 0, suspended = 0;

  usersSnap.forEach(d => {
    total++;
    const data = d.data();
    const role = data.role || "student";

    const untilMs = getSuspendedUntilMs(data);
    const susp = isSuspended(data);

    if (role === "admin") admins++;
    else students++;

    if (susp) suspended++;

    const card = document.createElement("div");
    card.className = "user-card";

    const top = document.createElement("div");
    top.className = "user-top";

    const left = document.createElement("div");
    const email = document.createElement("div");
    email.className = "user-email";
    email.textContent = data.email || "(sin correo)";
    const name = document.createElement("div");
    name.className = "user-name";
    name.textContent = data.name || "—";
    left.appendChild(email);
    left.appendChild(name);

    const pill = document.createElement("div");
    pill.className = "pill " + (role === "admin" ? "admin" : "student");
    pill.textContent = role === "admin" ? "Admin" : "Estudiante";

    top.appendChild(left);
    top.appendChild(pill);

    const grid = document.createElement("div");
    grid.className = "user-row";

    // Rol select
    const fRole = document.createElement("div");
    fRole.className = "user-field";
    const labR = document.createElement("label");
    labR.textContent = "Rol";
    const sel = document.createElement("select");
    ["admin","student"].forEach(r=>{
      const opt = document.createElement("option");
      opt.value = r;
      opt.textContent = r === "admin" ? "Admin" : "Estudiante";
      if (r === role) opt.selected = true;
      sel.appendChild(opt);
    });
    sel.addEventListener("change", async ()=>{
      await updateDoc(doc(db,"users",d.id),{ role: sel.value });
      await loadUsers();
    });
    fRole.appendChild(labR);
    fRole.appendChild(sel);

    // Suspensión info
    const fSusp = document.createElement("div");
    fSusp.className = "user-field";
    const labS = document.createElement("label");
    labS.textContent = "Suspensión";
    const vSusp = document.createElement("div");
    vSusp.className = "value";

    if (susp){
      vSusp.textContent = `Activa (${minutesLeft(untilMs)} min) · hasta ${fmtUntil(untilMs)}`;
    } else {
      vSusp.textContent = "No suspendido";
    }

    fSusp.appendChild(labS);
    fSusp.appendChild(vSusp);

    grid.appendChild(fRole);
    grid.appendChild(fSusp);

    // Actions
    const actions = document.createElement("div");
    actions.className = "user-actions";

    const btnSuspend = document.createElement("button");
    btnSuspend.className = "btn btn-warn";
    btnSuspend.textContent = "Suspender (min)";
    btnSuspend.addEventListener("click", async ()=>{
      const raw = await showPrompt({
        title:"Suspender usuario",
        message:"Ingresá la cantidad de minutos de suspensión.",
        placeholder:"Ej: 60",
        inputType:"number",
        validate:(val)=>{
          const n = parseInt(String(val || "").trim(),10);
          if (!Number.isFinite(n) || n <= 0) return "Ingresá un número mayor que 0.";
          return "";
        }
      });
      if (raw === null) return;
      const mins = parseInt(String(raw).trim(), 10);
      const until = Date.now() + mins*60000;

      try{
        await updateDoc(doc(db,"users",d.id),{
          suspended: true,
          suspendedUntil: until
        });
        await loadUsers();
        showToast({ message:`Usuario suspendido por ${mins} min.`, type:"warning" });
      }catch(e){
        showToast({ message:"Error al suspender: " + (e.message || e), type:"error" });
      }
    });

    const btnUnsuspend = document.createElement("button");
    btnUnsuspend.className = "btn btn-ok";
    btnUnsuspend.textContent = "Quitar suspensión";
    btnUnsuspend.addEventListener("click", async ()=>{
      try{
        await updateDoc(doc(db,"users",d.id),{
          suspended: false,
          suspendedUntil: 0
        });
        await loadUsers();
        showToast({ message:"Suspensión quitada.", type:"success" });
      }catch(e){
        showToast({ message:"Error al quitar suspensión: " + (e.message || e), type:"error" });
      }
    });

    // Chips de estado
    const statusPill = document.createElement("div");
    statusPill.className = "pill " + (susp ? "susp" : "");
    statusPill.textContent = susp ? "Suspendido" : "Activo";

    actions.appendChild(statusPill);
    actions.appendChild(btnSuspend);
    actions.appendChild(btnUnsuspend);

    card.appendChild(top);
    card.appendChild(grid);
    card.appendChild(actions);

    cont.appendChild(card);
  });

  qs("#metricUsersTotal").textContent = total.toString();
  qs("#metricUsersDetail").textContent =
    `Admin: ${admins} · Estudiantes: ${students} · Suspendidos: ${suspended}`;
  qs("#badgeUsers").textContent = String(total);
}

/* ---------- horarios ---------- */
async function loadSections(){
  const snap = await getDocs(collection(db,"courseSections"));
  const tbody = qs("#sectionsTableBody");
  tbody.innerHTML = "";

  let totalDocs = 0;
  const subjectsSet = new Set();

  snap.forEach(d =>{
    totalDocs++;
    const data = d.data();
    const subject = data.subject || "—";
    const commission = data.commission || "—";
    const room = data.room || "—";
    const campusDefault = data.campus || "—";
    const titular = data.titular || "";
    const docentesArr = Array.isArray(data.docentes) ? data.docentes : [];
    const days = Array.isArray(data.days) ? data.days : [];

    if (subject) subjectsSet.add(subject);

    let docentesLabel = "";
    if (titular) docentesLabel += "Titular: " + titular;
    if (docentesArr.length){
      const list = docentesArr.map(d0 => {
        const n = d0.name || "";
        const r = d0.role || "";
        return r ? `${n} (${r})` : n;
      }).join(", ");
      docentesLabel += (docentesLabel ? " · " : "") + list;
    }
    if (!docentesLabel) docentesLabel = "—";

    if (!days.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${subject}</td>
        <td>${commission}</td>
        <td>—</td>
        <td>—</td>
        <td>${campusDefault}</td>
        <td>${room}</td>
        <td>${docentesLabel}</td>
        <td>
          <button class="btn btn-outline btn-edit-section" data-id="${d.id}">Editar</button>
          <button class="btn btn-danger btn-delete-section" data-id="${d.id}">Borrar</button>
        </td>
      `;
      tbody.appendChild(tr);
    } else {
      days.forEach((dayObj, idx)=>{
        const tr = document.createElement("tr");
        const campus = dayObj.campus || campusDefault || "—";
        const horario = (dayObj.start || "") && (dayObj.end || "")
          ? `${dayObj.start} – ${dayObj.end}` : "—";
        tr.innerHTML = `
          <td>${idx === 0 ? subject : ""}</td>
          <td>${idx === 0 ? commission : ""}</td>
          <td>${dayObj.day || "—"}</td>
          <td>${horario}</td>
          <td>${campus}</td>
          <td>${idx === 0 ? room : ""}</td>
          <td>${idx === 0 ? docentesLabel : ""}</td>
          <td>
            <button class="btn btn-outline btn-edit-section" data-id="${d.id}">Editar</button>
            <button class="btn btn-danger btn-delete-section" data-id="${d.id}">Borrar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
  });

  qs("#metricSectionsTotal").textContent = String(totalDocs);
  qs("#metricSectionsDetail").textContent =
    "Materias distintas: " + subjectsSet.size;
  qs("#badgeSections").textContent = String(totalDocs);
}

/* ---------- NUEVO: funciones de profesores ---------- */
async function loadProfessors(){
  const tbody = qs("#professorsTableBody");
  tbody.innerHTML = "";

  let snap;
  try{
    snap = await getDocs(collection(db,"professors"));
  }catch(e){
    showToast({ message:"No se pudieron cargar profesores: " + (e.message || e), type:"error" });
    qs("#badgeProfessors").textContent = "0";
    qs("#metricProfessorsTotal").textContent = "0";
    qs("#metricProfessorsDetail").textContent = "Activos: 0 · Ocultos: 0";
    return;
  }
  let total = 0;
  let activeCount = 0;
  let hiddenCount = 0;

  snap.forEach(d =>{
    total++;
    const data = d.data() || {};
    const careers = Array.isArray(data.careers) ? data.careers : [];
    const subjects = Array.isArray(data.subjects) ? data.subjects : [];
    const active = !!data.active;
    const ratingCount = data.ratingCount || 0;
    const commentsCount = data.commentsCount || 0;
    const avg = typeof data.avgGeneral === "number" ? data.avgGeneral : 0;

    if (active) activeCount++;
    else hiddenCount++;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${data.name || "—"}</td>
      <td>${careers.join(", ") || "—"}</td>
      <td>${subjects.join(", ") || "—"}</td>
      <td>${active ? "<span class='pill ok'>Activo</span>" : "<span class='pill susp'>Oculto</span>"}</td>
      <td>${avg.toFixed(1)} ★</td>
      <td>${ratingCount} valoraciones · ${commentsCount} comentarios</td>
      <td>
        <div style="display:flex;gap:.4rem;flex-wrap:wrap;">
          <button class="btn btn-outline btn-edit-prof" data-id="${d.id}">Editar</button>
          <button class="btn ${active ? "btn-warn" : "btn-ok"} btn-toggle-prof" data-id="${d.id}">${active ? "Ocultar" : "Publicar"}</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  qs("#badgeProfessors").textContent = String(total);
  qs("#metricProfessorsTotal").textContent = String(total);
  qs("#metricProfessorsDetail").textContent = `Activos: ${activeCount} · Ocultos: ${hiddenCount}`;
}

function setCareerSelectOptions(){
  const sel = qs("#profCareerSelect");
  if (!sel) return;
  const selected = new Set(professorCareers.map(c => c.slug));
  sel.innerHTML = `<option value=\"\">Elegí carrera…</option>`;
  plansIndex.forEach(p =>{
    const opt = document.createElement("option");
    opt.value = p.slug;
    opt.textContent = p.nombre || p.slug;
    opt.disabled = selected.has(p.slug);
    sel.appendChild(opt);
  });
}

function renderCareerChips(){
  const cont = qs("#profCareersChips");
  cont.innerHTML = "";
  professorCareers.forEach((c, idx)=>{
    const chip = document.createElement("span");
    chip.className = "chip";
    chip.innerHTML = `
      <span>${c.name}</span>
      <span class="chip-remove" data-idx="${idx}">✕</span>
    `;
    chip.querySelector(".chip-remove").addEventListener("click", ()=>{
      professorCareers.splice(idx,1);
      professorSubjects = professorSubjects.filter(s => !s.careerSlug || professorCareers.some(cc => cc.slug === s.careerSlug));
      renderCareerChips();
      renderSubjectCareerSelect();
      renderSubjectChips();
    });
    cont.appendChild(chip);
  });
  setCareerSelectOptions();
  setSubjectSelectorsAvailability();
}

function renderSubjectChips(){
  const cont = qs("#profSubjectsChips");
  cont.innerHTML = "";
  professorSubjects.forEach((s, idx)=>{
    const labelCareer = s.careerSlug
      ? (professorCareers.find(c => c.slug === s.careerSlug)?.name || planNameFromSlug(s.careerSlug))
      : "Sin carrera";
    const chip = document.createElement("span");
    chip.className = "chip";
    chip.innerHTML = `
      <span>${s.name}${s.careerSlug ? " — " + labelCareer : ""}</span>
      <span class="chip-remove" data-idx="${idx}">✕</span>
    `;
    chip.querySelector(".chip-remove").addEventListener("click", ()=>{
      professorSubjects.splice(idx,1);
      renderSubjectChips();
      updateSubjectSelectOptions().catch(console.error);
    });
    cont.appendChild(chip);
  });
}

function renderSubjectCareerSelect(){
  const sel = qs("#profSubjectCareerSelect");
  const selSubject = qs("#profSubjectSelect");
  setSubjectSelectorsAvailability();
  if (!sel || !selSubject) return;
  const current = sel.value;
  sel.innerHTML = `<option value=\"\">Elegí carrera…</option>`;
  if (!professorCareers.length) return;
  professorCareers.forEach(c =>{
    const opt = document.createElement("option");
    opt.value = c.slug;
    opt.textContent = c.name;
    sel.appendChild(opt);
  });
  if (professorCareers.length === 1){
    sel.value = professorCareers[0].slug;
  } else if (current && professorCareers.some(c => c.slug === current)){
    sel.value = current;
  }
  updateSubjectSelectOptions().catch(console.error);
}

async function updateSubjectSelectOptions(){
  const selCareer = qs("#profSubjectCareerSelect");
  const sel = qs("#profSubjectSelect");
  if (!selCareer || !sel) return;
  if (!professorCareers.length){
    setSubjectSelectorsAvailability();
    return;
  }
  sel.innerHTML = `<option value=\"\">Elegí materia…</option>`;
  const selectedPairs = new Set(professorSubjects.map(s => `${s.careerSlug}|${s.id}`));
  const hasMultipleCareers = professorCareers.length > 1;

  if (hasMultipleCareers){
    selCareer.disabled = true;
    selCareer.value = "";
    const subjectLists = await Promise.all(professorCareers.map(async career => {
      const list = await getSubjectsForCareer(career.slug);
      return list.map(sub => ({ sub, career }));
    }));
    const unique = new Set();
    const flat = subjectLists.flat();
    flat.forEach(({ sub, career }) => {
      const id = sub.id || sub.nombre;
      if (!id) return;
      const key = `${career.slug}|${id}`;
      if (unique.has(key)) return;
      unique.add(key);
      const opt = document.createElement("option");
      opt.value = id;
      opt.textContent = `${sub.nombre || sub.id || "Materia"} — ${career.name || planNameFromSlug(career.slug)}`;
      opt.dataset.careerSlug = career.slug;
      opt.dataset.subjectName = sub.nombre || sub.id || "Materia";
      opt.disabled = selectedPairs.has(key);
      sel.appendChild(opt);
    });
    return;
  }

  selCareer.disabled = false;
  if (!selCareer.value && professorCareers.length === 1){
    selCareer.value = professorCareers[0].slug;
  }
  const slug = selCareer.value;
  if (!slug) return;
  const subjects = await getSubjectsForCareer(slug);
  subjects.forEach(sub =>{
    const id = sub.id || sub.nombre;
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = sub.nombre || sub.id || "Materia";
    opt.dataset.careerSlug = slug;
    opt.dataset.subjectName = sub.nombre || sub.id || "Materia";
    opt.disabled = selectedPairs.has(`${slug}|${id}`);
    sel.appendChild(opt);
  });
}

function hydrateCareers(data){
  if (Array.isArray(data?.careerSlugs) && data.careerSlugs.length){
    return data.careerSlugs.map(slug =>{
      const plan = plansIndex.find(p => p.slug === slug);
      return plan ? { slug: plan.slug, name: plan.nombre } : { slug, name: slug };
    });
  }
  if (Array.isArray(data?.careers)) return mapCareersToPlans(data.careers);
  return [];
}

function hydrateSubjects(data){
  const pairs = Array.isArray(data?.subjectPairs) ? data.subjectPairs : [];
  const mapped = pairs.map(p => ({
    id: p.subjectId || p.id || p.subjectName || "",
    name: p.subjectName || p.subjectId || p.id || "",
    careerSlug: p.careerSlug || p.career || ""
  })).filter(p => p.id && p.name);
  if (mapped.length) return mapped;

  const subjects = Array.isArray(data?.subjects) ? data.subjects : [];
  if (!subjects.length) return [];
  if (professorCareers.length === 1){
    return subjects.map(name => ({ id: normalizeStr(name) || name, name, careerSlug: professorCareers[0].slug }));
  }
  return subjects.map(name => ({ id: normalizeStr(name) || name, name, careerSlug: "" }));
}

async function alignSubjectsWithCareers(){
  if (!professorSubjects.length || !professorCareers.length) return;
  await Promise.all(professorCareers.map(c => getSubjectsForCareer(c.slug)));
  professorSubjects = professorSubjects.map(sub =>{
    if (sub.careerSlug) return sub;
    const matches = professorCareers.filter(c =>{
      const list = planSubjectsCache.get(c.slug) || [];
      return list.some(m => normalizeStr(m.nombre||m.id) === normalizeStr(sub.name) || normalizeStr(m.id) === normalizeStr(sub.id));
    });
    if (matches.length === 1){
      return { ...sub, careerSlug: matches[0].slug };
    }
    return sub;
  });
}

async function openProfessorModal(id, data=null){
  await ensurePlansIndex();
  editingProfessorId = id || null;
  professorCareers = hydrateCareers(data);
  professorSubjects = hydrateSubjects(data);

  if (professorCareers.length === 1){
    professorSubjects = professorSubjects.map(s => ({ ...s, careerSlug: s.careerSlug || professorCareers[0].slug }));
  }
  await alignSubjectsWithCareers();

  qs("#profModalTitle").textContent = id ? "Editar profesor" : "Nuevo profesor";
  qs("#btnDeleteProfessor").style.display = id ? "inline-flex" : "none";

  qs("#profName").value = data?.name || "";
  qs("#profActive").checked = !!data?.active;

  setCareerSelectOptions();
  renderCareerChips();
  renderSubjectCareerSelect();
  renderSubjectChips();

  qs("#profModalBg").style.display = "flex";
}

function closeProfessorModal(){
  qs("#profModalBg").style.display = "none";
  editingProfessorId = null;
  professorCareers = [];
  professorSubjects = [];
  ["#profCareerSelect","#profSubjectCareerSelect","#profSubjectSelect"].forEach(id => {
    const el = qs(id);
    if (el) el.value = "";
  });
  setSubjectSelectorsAvailability();
}

async function addCareerToList(){
  await ensurePlansIndex();
  const sel = qs("#profCareerSelect");
  const slug = sel.value;
  if (!slug){
    showToast({ message:"Elegí una carrera del listado.", type:"warning" });
    return;
  }
  if (professorCareers.some(c => c.slug === slug)) return;
  const plan = plansIndex.find(p => p.slug === slug);
  professorCareers.push({ slug, name: plan?.nombre || slug });
  renderCareerChips();
  renderSubjectCareerSelect();
  sel.value = "";
}

async function addSubjectToList(){
  const selCareer = qs("#profSubjectCareerSelect");
  const sel = qs("#profSubjectSelect");
  const option = sel?.selectedOptions?.[0] || null;
  const slug = option?.dataset?.careerSlug || selCareer?.value || "";
  const id = option?.value || "";
  if (!id){
    showToast({ message:"Elegí una materia del selector.", type:"warning" });
    return;
  }
  if (!slug){
    showToast({ message:"Elegí una materia que indique la carrera asociada.", type:"warning" });
    return;
  }
  const subjects = await getSubjectsForCareer(slug);
  const match = subjects.find(s => (s.id || s.nombre) === id || normalizeStr(s.nombre||s.id) === normalizeStr(id));
  const name = option?.dataset?.subjectName || match?.nombre || match?.id || option?.textContent || id;
  const internalId = match?.id || id;
  const key = `${slug}|${internalId}`;
  const exists = professorSubjects.some(s => `${s.careerSlug}|${s.id}` === key);
  if (exists){
    showToast({ message:"Esa materia ya está asociada a la carrera.", type:"info" });
    return;
  }
  professorSubjects.push({ id: internalId, name, careerSlug: slug });
  renderSubjectChips();
  updateSubjectSelectOptions().catch(console.error);
  if (sel) sel.value = "";
}

async function saveProfessor(){
  const name = qs("#profName").value.trim();
  const active = qs("#profActive").checked;

  if (!name){
    showToast({ message:"Ingresá el nombre del profesor.", type:"warning" });
    return;
  }
  if (!professorCareers.length){
    showToast({ message:"Cargá al menos una carrera.", type:"warning" });
    return;
  }
  if (!professorSubjects.length){
    showToast({ message:"Cargá al menos una materia.", type:"warning" });
    return;
  }

  const careerSlugs = new Set(professorCareers.map(c => c.slug));
  if (professorSubjects.some(s => !s.careerSlug || !careerSlugs.has(s.careerSlug))){
    showToast({ message:"Cada materia debe pertenecer a una carrera seleccionada.", type:"warning" });
    return;
  }

  const payload = {
    name,
    careers: professorCareers.map(c => c.name),
    careerSlugs: professorCareers.map(c => c.slug),
    subjects: professorSubjects.map(s => s.name),
    subjectIds: professorSubjects.map(s => s.id),
    subjectPairs: professorSubjects.map(s => ({ careerSlug: s.careerSlug, subjectId: s.id, subjectName: s.name })),
    active,
    createdBy: currentUser?.uid || "",
    updatedAt: serverTimestamp()
  };

  try{
    if (editingProfessorId){
      await updateDoc(doc(db,"professors",editingProfessorId), payload);
    } else {
      payload.createdAt = serverTimestamp();
      payload.avgGeneral = 0;
      payload.avgTeaching = 0;
      payload.avgExams = 0;
      payload.avgTreatment = 0;
      payload.ratingCount = 0;
      payload.commentsCount = 0;
      await addDoc(collection(db,"professors"), payload);
    }
    closeProfessorModal();
    await loadProfessors();
    showToast({ message:"Profesor guardado.", type:"success" });
  }catch(e){
    const msg = (e && e.message) ? e.message : e;
    showToast({ message:"Error al guardar profesor: " + msg, type:"error" });
  }
}

async function deleteProfessor(){
  if (!editingProfessorId) return;
  const ok = await showConfirm({
    title:"Eliminar profesor",
    message:"Esto eliminará el profesor. Las reseñas permanecen en la colección si existen.",
    confirmText:"Eliminar",
    cancelText:"Cancelar",
    danger:true
  });
  if (!ok) return;
  try{
    await deleteDoc(doc(db,"professors",editingProfessorId));
    closeProfessorModal();
    await loadProfessors();
    showToast({ message:"Profesor eliminado.", type:"success" });
  }catch(e){
    showToast({ message:"No se pudo eliminar: " + (e.message || e), type:"error" });
  }
}

/* ---------- modal horarios ---------- */
async function openSectionModal(id, data=null){
  editingSectionId = id || null;
  daysList = [];
  docentesList = [];

  qs("#sectionModalTitle").textContent = id ? "Editar horario" : "Nuevo horario";
  qs("#btnDeleteSection").style.display = id ? "inline-flex" : "none";

  await setSectionCareerOptions(data?.degreeSlug || "", data?.degree || "");
  await updateSectionSubjectOptions(data?.subjectId || data?.subject || "", data?.degreeSlug || "", data?.subject || "");
  qs("#secCommission").value = data?.commission || "";
  qs("#secRoom").value       = data?.room || "";
  qs("#secCampus").value     = data?.campus || "";
  qs("#secHeadEmail").value  = data?.headEmail || "";
  qs("#secTitular").value    = data?.titular || "";

  if (Array.isArray(data?.docentes)){
    docentesList = data.docentes.map(d => ({
      name: d.name || "",
      role: d.role || "Docente"
    }));
  }
  if (Array.isArray(data?.days)){
    daysList = data.days.map(d => ({
      day: d.day || "",
      start: d.start || "",
      end: d.end || "",
      campus: d.campus || ""
    }));
  }

  renderDocentesChips();
  renderDaysChips();

  qs("#sectionModalBg").style.display = "flex";
}

function closeSectionModal(){
  qs("#sectionModalBg").style.display = "none";
  editingSectionId = null;
  daysList = [];
  docentesList = [];
  const selDegree = qs("#secDegree");
  const selSubject = qs("#secSubject");
  if (selDegree) selDegree.value = "";
  if (selSubject){
    selSubject.innerHTML = `<option value=\"\">Elegí materia…</option>`;
    selSubject.disabled = true;
  }
}

/* docentes chips */
function renderDocentesChips(){
  const cont = qs("#docentesChips");
  cont.innerHTML = "";
  docentesList.forEach((d, idx)=>{
    const chip = document.createElement("span");
    chip.className = "chip";
    chip.innerHTML = `
      <span>${d.name} — ${d.role}</span>
      <span class="chip-remove" data-idx="${idx}">✕</span>
    `;
    chip.querySelector(".chip-remove").addEventListener("click", ()=>{
      docentesList.splice(idx,1);
      renderDocentesChips();
    });
    cont.appendChild(chip);
  });
}

function addDocenteToList(){
  const name = qs("#docenteName").value.trim();
  const role = qs("#docenteRole").value || "Docente";
  if (!name){
    showToast({ message:"Ingresá el nombre del docente.", type:"warning" });
    return;
  }
  docentesList.push({ name, role });
  qs("#docenteName").value = "";
  renderDocentesChips();
}

/* days chips */
function renderDaysChips(){
  const cont = qs("#daysChips");
  cont.innerHTML = "";
  daysList.forEach((d, idx)=>{
    const texto = `${d.day} ${d.start || ""}–${d.end || ""}${d.campus ? " · " + d.campus : ""}`;
    const chip = document.createElement("span");
    chip.className = "chip";
    chip.innerHTML = `
      <span>${texto}</span>
      <span class="chip-remove" data-idx="${idx}">✕</span>
    `;
    chip.querySelector(".chip-remove").addEventListener("click", ()=>{
      daysList.splice(idx,1);
      renderDaysChips();
    });
    cont.appendChild(chip);
  });
}

function addDayToList(){
  const day    = qs("#daySelect").value;
  const start  = qs("#dayStart").value;
  const end    = qs("#dayEnd").value;
  const campus = qs("#dayCampus").value || qs("#secCampus").value || "";

  if (!day || !start || !end){
    showToast({ message:"Completá día, hora de inicio y fin.", type:"warning" });
    return;
  }
  if (start >= end){
    showToast({ message:"La hora de inicio debe ser menor que la de fin.", type:"warning" });
    return;
  }
  if (daysList.length >= 2){
    showToast({ message:"Sólo se permiten hasta 2 días por comisión.", type:"warning" });
    return;
  }
  if (daysList.some(d => d.day === day)){
    showToast({ message:"Ese día ya está cargado para esta comisión.", type:"warning" });
    return;
  }

  daysList.push({ day, start, end, campus });
  renderDaysChips();

  qs("#daySelect").value = "";
  qs("#dayStart").value = "";
  qs("#dayEnd").value = "";
  qs("#dayCampus").value = "";
}

/* guardar / borrar horario */
async function saveSection(){
  const selSubject = qs("#secSubject");
  const selDegree  = qs("#secDegree");
  const subjectId  = selSubject?.value.trim() || "";
  const subjectName = selSubject?.selectedOptions?.[0]?.dataset?.subjectName || subjectId;
  const commission = qs("#secCommission").value.trim();
  const degreeSlug = selDegree?.value || "";
  const degreeName = selDegree?.selectedOptions?.[0]?.dataset?.name || "";
  const room       = qs("#secRoom").value.trim();
  const campus     = qs("#secCampus").value;
  const headEmail  = qs("#secHeadEmail").value.trim();
  const titular    = qs("#secTitular").value.trim();

  const isCustomDegree = selDegree?.selectedOptions?.[0]?.dataset?.custom === "true";

  if (!degreeSlug && !isCustomDegree){
    showToast({ message:"Elegí una carrera para listar sus materias.", type:"warning" });
    return;
  }
  if (!subjectName || !subjectId){
    showToast({ message:"Elegí una materia del listado.", type:"warning" });
    return;
  }
  if (!commission){
    showToast({ message:"Completá la comisión.", type:"warning" });
    return;
  }
  if (!daysList.length){
    showToast({ message:"Cargá al menos un día y horario.", type:"warning" });
    return;
  }

  const payload = {
    subject: subjectName,
    subjectId,
    commission,
    degree: degreeName || "",
    degreeSlug: degreeSlug || "",
    room: room || "",
    campus: campus || "",
    headEmail: headEmail || "",
    titular: titular || "",
    docentes: docentesList,
    days: daysList,
    updatedAt: serverTimestamp()
  };

  try{
    if (editingSectionId){
      await updateDoc(doc(db,"courseSections",editingSectionId), payload);
    } else {
      payload.createdAt = serverTimestamp();
      await addDoc(collection(db,"courseSections"), payload);
    }
    closeSectionModal();
    await loadSections();
    showToast({ message:"Horario guardado correctamente.", type:"success" });
  }catch(e){
    showToast({ message:"Error al guardar horario: " + (e.message || e), type:"error" });
  }
}

async function deleteCurrentSection(){
  if (!editingSectionId) return;
  const ok = await showConfirm({
    title:"Eliminar horario",
    message:"Vas a eliminar esta comisión y sus días.",
    confirmText:"Eliminar",
    cancelText:"Cancelar",
    danger:true
  });
  if (!ok) return;
  try{
    await deleteDoc(doc(db,"courseSections",editingSectionId));
    closeSectionModal();
    await loadSections();
    showToast({ message:"Horario eliminado.", type:"success" });
  }catch(e){
    showToast({ message:"Error al borrar horario: " + (e.message || e), type:"error" });
  }
}
</script>
</body>
</html>
