rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /chats/{chatId} {
      function isParticipant(data) {
        return request.auth != null
          && ((data.users is list && request.auth.uid in data.users)
            || (data.uids is list && request.auth.uid in data.uids));
      }

      allow read: if isParticipant(resource.data);

      allow create: if request.auth != null
        && ((request.resource.data.users is list && request.auth.uid in request.resource.data.users)
          || (request.resource.data.uids is list && request.auth.uid in request.resource.data.uids));

      allow update: if isParticipant(resource.data)
        && request.resource.data.diff(resource.data).changedKeys()
          .hasOnly(['lastMessage', 'updatedAt', 'users', 'uids', 'createdAt']);

      allow delete: if false;

      match /messages/{messageId} {
        function senderMatches() {
          return request.auth != null
            && ((request.resource.data.senderUid is string && request.resource.data.senderUid == request.auth.uid)
              || (request.resource.data.senderId is string && request.resource.data.senderId == request.auth.uid));
        }

        allow read: if isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data);
        allow create: if senderMatches()
          && isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data);
        allow update, delete: if false;
      }
    }
  }
}
