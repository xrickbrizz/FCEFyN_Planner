rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function isOwner(uid) { return signedIn() && request.auth.uid == uid; }
    function isAdmin() {
      return signedIn() && (
        request.auth.token.admin == true ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
      );
    }

    // ---- users (privado) ----
    match /users/{uid} {
      allow read: if isOwner(uid) || isAdmin();
      allow create: if isOwner(uid) || isAdmin();
      allow update: if isOwner(uid) || isAdmin();
      allow delete: if isAdmin();
    }

    // ---- publicUsers (directorio) ----
    match /publicUsers/{uid} {
      allow read: if signedIn();
      allow create, update: if isOwner(uid) || isAdmin();
      allow delete: if isOwner(uid) || isAdmin();
    }

    // ---- planner ----
    match /planner/{uid} {
      allow read, create, update: if isOwner(uid) || isAdmin();
      allow delete: if isAdmin();
    }

    // ---- courseSections (admin) ----
    match /courseSections/{id} {
      allow read: if signedIn();
      allow create, update, delete: if isAdmin();
    }

    // ---- status / presencia ----
    match /userStatus/{uid} {
      allow read: if signedIn();
      allow create, update: if isOwner(uid);
      allow delete: if false;
    }

    // ---- solicitudes ----
    match /friendRequests/{id} {
      function reqFrom(data) {
        return data.fromUid is string ? data.fromUid :
               data.senderUid is string ? data.senderUid :
               data.senderId is string ? data.senderId : "";
      }
      function reqTo(data) {
        return data.toUid is string ? data.toUid :
               data.receiverUid is string ? data.receiverUid :
               data.recipientUid is string ? data.recipientUid : "";
      }

      allow read: if signedIn() && (
        request.auth.uid == reqFrom(resource.data) ||
        request.auth.uid == reqTo(resource.data) ||
        isAdmin()
      );

      allow create: if signedIn()
        && reqFrom(request.resource.data) == request.auth.uid
        && reqTo(request.resource.data) is string
        && request.resource.data.status == "pending";

      allow update: if signedIn() && (
        // receiver acepta/rechaza
        (
          request.auth.uid == reqTo(resource.data) &&
          request.resource.data.diff(resource.data).changedKeys()
            .hasOnly(["status","updatedAt","decisionBy"]) &&
          (request.resource.data.status in ["accepted","rejected"])
        )
        ||
        // sender cancela
        (
          request.auth.uid == reqFrom(resource.data) &&
          request.resource.data.diff(resource.data).changedKeys()
            .hasOnly(["status","updatedAt","canceledBy"]) &&
          request.resource.data.status == "canceled"
        )
      );

      allow delete: if false;
    }

    // ---- friends (legacy/compat) ----
    match /friends/{chatId} {
      allow read: if signedIn() && (request.auth.uid in resource.data.uids);
      allow create: if signedIn() && (request.auth.uid in request.resource.data.uids);
      allow update: if signedIn()
        && (request.auth.uid in resource.data.uids)
        && request.resource.data.uids == resource.data.uids
        && request.resource.data.chatId == resource.data.chatId
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(["createdAt","uids","chatId"]);
      allow delete: if false;
    }

    // ---- chats + messages ----
    match /chats/{chatId} {

      function isParticipant(data) {
        return signedIn()
          && ((data.users is list && request.auth.uid in data.users)
            || (data.uids is list && request.auth.uid in data.uids));
      }

      allow read: if isParticipant(resource.data);

      allow create: if signedIn()
        && ((request.resource.data.users is list && request.auth.uid in request.resource.data.users)
          || (request.resource.data.uids is list && request.auth.uid in request.resource.data.uids));

      // no permitir cambiar miembros ni createdAt una vez creado
      allow update: if isParticipant(resource.data)
        && request.resource.data.diff(resource.data).changedKeys()
          .hasOnly(['lastMessage','updatedAt','users','uids'])
        && request.resource.data.users == resource.data.users
        && request.resource.data.uids == resource.data.uids;

      allow delete: if false;

      match /messages/{messageId} {
        function senderMatches() {
          return signedIn()
            && ((request.resource.data.senderUid is string && request.resource.data.senderUid == request.auth.uid)
              || (request.resource.data.senderId is string && request.resource.data.senderId == request.auth.uid));
        }

        allow read: if isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data);

        allow create: if senderMatches()
          && isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data);

        allow update, delete: if false;
      }
    }
  }
}
